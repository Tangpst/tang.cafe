<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文章详情</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<style>
:root{
  --bg:linear-gradient(135deg,#f5f7fa,#c3cfe2);
  --text:#111;
  --card-bg:rgba(255,255,255,0.95);
  --card-shadow:rgba(0,0,0,0.1);
  --accent:#007bff;
  --highlight:#ffd54f;
}
[data-theme="dark"]{
  --bg:linear-gradient(135deg,#1e1e1e,#2c2c2c);
  --text:#eee;
  --card-bg:rgba(30,30,30,0.9);
  --card-shadow:rgba(0,0,0,0.6);
  --accent:#4da6ff;
  --highlight:#ffab40;
}
body{
  background:var(--bg);
  color:var(--text);
  font-family:'Segoe UI',Arial,sans-serif;
  margin:0;padding:20px;
  transition:background 0.3s,color 0.3s;
  line-height:1.75;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
  flex-wrap:wrap;
}
header button{
  cursor:pointer;
  padding:6px 12px;
  border-radius:6px;
  border:0px solid var(--text);
  background:var(--card-bg);
  backdrop-filter:blur(5px);
  display:flex;align-items:center;gap:5px;
  color:var(--text);
  transition:all 0.3s;
}
header button:hover{
  background:var(--accent);
  color:#fff;
}
article{
  background:var(--card-bg);
  padding:30px;
  border-radius:16px;
  box-shadow:0 6px 16px var(--card-shadow);
  color:var(--text);
  overflow:hidden;
}

/* Markdown 美化 */
article h1,article h2,article h3,article h4{
  margin:20px 0 12px;
  font-weight:600;
}
article p{margin:12px 0;}
article a{color:var(--accent);text-decoration:none;}
article a:hover{text-decoration:underline;}
article blockquote{
  border-left:4px solid var(--accent);
  padding-left:12px;
  color:var(--text);
  background:#f9f9f9;
  border-radius:6px;
  margin:15px 0;
}
article pre, article code{
  background:#f5f2f0;
  border-radius:6px;
  padding:6px 10px;
  font-family:monospace;
  overflow-x:auto;
  color:var(--accent);
}
article pre{padding:14px;}

/* 图片 */
article img{
  width:100%;
  max-width:800px;
  height:auto;
  margin:15px 0;
  border-radius:12px;
  cursor:pointer;
  opacity:0;
  transition:opacity 0.5s, transform 0.3s;
}

/* Lightbox */
#lightbox{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  overflow:hidden;
}
#lightbox .lightbox-inner{
  display:flex;
  height:100%;
  transition: transform 0.3s ease;
}
#lightbox img{
  max-width:90%;
  max-height:90%;
  object-fit:contain;
  flex-shrink:0;
  margin:auto;
  border-radius:12px;
}

/* skeleton */
.skeleton{background:#ddd;border-radius:12px;margin-bottom:12px;height:16px;position:relative;overflow:hidden;}
.skeleton::before{content:""; display:block; position:absolute; top:0; left:-150px; height:100%; width:150px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation:skeleton-loading 1.2s infinite;}
@keyframes skeleton-loading{0%{left:-150px;}100%{left:100%;}}
@media(max-width:768px){body{padding:12px;}header{flex-direction:column;align-items:flex-start;gap:8px;}header h1{font-size:22px;}article{padding:20px;border-radius:12px;}article h1{font-size:22px;}}
</style>
</head>
<body data-theme="light">
<header>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <button onclick="window.history.back()"><i class="bi bi-arrow-left-circle"></i> 返回</button>
    <button class="toggle"><i class="bi bi-moon-stars"></i> 暗黑模式</button>
  </div>
  <h1><i class="bi bi-journal-text"></i> 文章详情</h1>
</header>

<article id="postContent">
  <div class="skeleton" style="width:60%;height:24px;margin-bottom:12px;"></div>
  <div class="skeleton" style="width:30%;height:16px;margin-bottom:12px;"></div>
  <div class="skeleton" style="width:100%;height:16px;margin-bottom:6px;"></div>
  <div class="skeleton" style="width:90%;height:16px;margin-bottom:6px;"></div>
  <div class="skeleton" style="width:80%;height:16px;margin-bottom:6px;"></div>
</article>

<!-- Lightbox -->
<div id="lightbox"><div class="lightbox-inner"></div></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// 主题
function updateThemeUI(theme){
  document.body.setAttribute('data-theme',theme);
  document.querySelectorAll('.toggle').forEach(btn=>{
    if(theme==='dark'){btn.innerHTML='<i class="bi bi-sun-fill"></i> 浅色模式';}
    else{btn.innerHTML='<i class="bi bi-moon-stars"></i> 暗黑模式';}
  });
}
function loadTheme(){
  const savedTheme=localStorage.getItem('theme')||'light';
  updateThemeUI(savedTheme);
}
loadTheme();
document.querySelectorAll('.toggle').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const current=document.body.getAttribute('data-theme')==='dark'?'light':'dark';
    updateThemeUI(current);
    localStorage.setItem('theme',current);
  });
});

// 工具函数
function highlightKeyword(text,keyword){if(!keyword)return text;const regex=new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');return text.replace(regex,'<mark>$1</mark>');}
function getQuery(name){const params=new URLSearchParams(window.location.search);return params.get(name);}
const id=getQuery('id'), keyword=getQuery('keyword')||'', articleEl=document.getElementById('postContent');

// 加载文章
async function loadPost(){
  try{
    const res=await fetch(`https://api.tang.cafe/api/v1?id=${id}`);
    const data=await res.json();
    if(data.success && data.data){
      const post=data.data;
      articleEl.innerHTML=`
        <h1><i class="bi bi-file-earmark-text"></i> ${highlightKeyword(post.标题,keyword)}</h1>
        <div class="post-date"><i class="bi bi-clock"></i> ${new Date(post.日期).toLocaleDateString()}</div>
        <div class="markdown-body">${highlightKeyword(marked.parse(post.文章内容),keyword)}</div>
      `;

      // 图片懒加载
      const imgs=articleEl.querySelectorAll("img");
      imgs.forEach(img=>{
        img.loading="lazy";
        img.addEventListener("load",()=>{img.style.opacity=1;});
        img.addEventListener("click",()=>openLightbox(imgs, Array.from(imgs).indexOf(img)));
      });

    }else{articleEl.innerHTML='<p>未找到文章</p>';}
  }catch(e){articleEl.innerHTML='<p>加载失败，请稍后重试</p>';}
}
loadPost();

// Lightbox 功能
const lightbox=document.getElementById("lightbox");
const inner=document.querySelector("#lightbox .lightbox-inner");
let currentIndex=0;
function openLightbox(images,index){
  currentIndex=index;
  inner.innerHTML='';
  images.forEach(img=>{
    const clone=document.createElement("img");
    clone.src=img.src;
    inner.appendChild(clone);
  });
  lightbox.style.display="flex";
  updateLightbox();
}
function updateLightbox(){inner.style.transform=`translateX(${-currentIndex*100}%)`;}
lightbox.addEventListener("click",(e)=>{
  if(e.target===lightbox){lightbox.style.display="none";}
});
document.addEventListener("keydown",e=>{
  if(lightbox.style.display!=="flex")return;
  if(e.key==="ArrowRight"){currentIndex=Math.min(currentIndex+1,inner.children.length-1);updateLightbox();}
  if(e.key==="ArrowLeft"){currentIndex=Math.max(currentIndex-1,0);updateLightbox();}
});
</script>
</body>
</html>
