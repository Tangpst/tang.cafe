<!DOCTYPE html>
<html lang="zh">
<head>
<link rel="icon" href="./favicon.svg" type="image/svg+xml">
<link rel="icon" href="./favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文章详情</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
<style>
/* 添加头部过渡效果 */
header {
  transition: all 0.3s ease;
  padding: 15px 20px; /* 增加初始内边距 */
}

/* 滚动时缩小的头部样式 */
header.scrolled {
  padding: 8px 15px; /* 缩小内边距 */
  box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* 添加阴影增强效果 */
}

header.scrolled h1 {
  font-size: 18px; /* 标题字体缩小 */
  transform: scale(0.9); /* 轻微缩小 */
  transform-origin: center left; /* 以左侧为中心缩小 */
}

header.scrolled button {
  padding: 5px 10px; /* 按钮内边距缩小 */
  font-size: 0.9em; /* 按钮文字缩小 */
}

header.scrolled .header-left {
  gap: 6px; /* 缩小元素间距 */
}

/* 原有样式保持不变 */
:root{
  --bg:linear-gradient(135deg,#f5f7fa,#c3cfe2);
  --text:#111;
  --card-bg:rgba(255,255,255,0.95);
  --card-shadow:rgba(0,0,0,0.1);
  --accent:#34dbcb;
  --highlight:#ffd54f;
  --blockquote-bg:#f9f9f9;
  --blockquote-text:#555;
}
[data-theme="dark"]{
  --bg:linear-gradient(135deg,#1e1e1e,#2c2c2c);
  --text:#eee;
  --card-bg:rgba(30,30,30,0.9);
  --card-shadow:rgba(0,0,0,0.6);
  --accent:#34dbcb;
  --highlight:#ffab40;
  --blockquote-bg:#2a2a2a;
  --blockquote-text:#ccc;
}
body{
  background:var(--bg);
  color:var(--text);
  font-family:'Segoe UI',Arial,sans-serif;
  margin:0;padding:20px;
  transition:background 0.3s,color 0.3s;
  line-height:1.75;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  font-family: 'Noto Serif SC', serif;
}
.content-container {
  max-width: 1200px;
  width: 100%;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
  flex-wrap:nowrap; /* 禁止换行 */
  position: fixed; /* 固定定位 */
  top: 0; /* 距离顶部0 */
  left: 0; /* 距离左侧0 */
  right: 0; /* 距离右侧0 */
  background: var(--bg); /* 背景与页面一致 */
  padding: 10px 20px; /* 添加内边距 */
  z-index: 1000; /* 确保在其他元素上方 */
  backdrop-filter: blur(5px); /* 添加毛玻璃效果 */
}

/* 同时需要调整内容容器的上边距，避免被固定的header遮挡 */
.content-container {
  max-width: 1200px;
  width: 100%;
  margin-top: 70px; /* 增加上边距，值略大于header的高度 */
}
header .header-left{
  display:flex;
  gap:10px;
  flex-wrap:nowrap; /* 禁止换行 */
  align-items:center;
}
header h1{
  margin:0;
  font-size:22px;
  display:flex;
  align-items:center;
  gap:10px;
  flex-shrink: 0;
  white-space: nowrap; /* 禁止文字换行 */
  overflow: hidden; /* 隐藏溢出内容 */
  text-overflow: ellipsis; /* 显示省略号 */
  max-width: calc(100% - 140px); /* 限制最大宽度，为按钮留出空间 */
}
header button{
  cursor:pointer;
  padding:6px 12px;
  border-radius:6px;
  border:0;
  background:var(--card-bg);
  backdrop-filter:blur(5px);
  display:flex;align-items:center;gap:5px;
  color:var(--text);
  transition:all 0.3s;
}
header button:hover{
  background:var(--accent);
  color:#fff;
}
article{
  background:var(--card-bg);
  padding:30px;
  border-radius:16px;
  box-shadow:0 6px 16px var(--card-shadow);
  color:var(--text);
  overflow:hidden;
  max-width: 1000px;
  margin: 0 auto;
}
article h1,article h2,article h3,article h4{
  margin:20px 0 12px;
  font-weight:600;
}
article h1 { font-size: 2rem; }
article h2 { font-size: 1.75rem; border-bottom: 2px solid var(--accent); padding-bottom: 8px; }
article h3 { font-size: 1.5rem; }
article p{margin:12px 0; font-size: 1.1rem;}
article a{color:var(--accent);text-decoration:none; font-weight: 500;}
article a:hover{text-decoration:underline;}
article blockquote{
  border-left:4px solid var(--accent);
  padding: 16px 20px;
  color:var(--blockquote-text);
  background:var(--blockquote-bg);
  border-radius:0 6px 6px 0;
  margin:20px 0;
}
article pre, article code{
  background:#f5f2f0;
  border-radius:6px;
  padding:6px 10px;
  font-family:monospace;
  overflow-x:auto;
  color:var(--accent);
}
article pre{
  padding:14px;
  background-color: rgba(0, 123, 255, 0.1);
  border-left: 3px solid var(--accent);
}
article img{
  display: block;
  width:80%;
  max-width:600px;
  height:auto;
  margin:15px auto;
  border-radius:12px;
  cursor:pointer;
  opacity:0;
  transition:opacity 0.5s, transform 0.3s;
}
#lightbox{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.85);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  opacity:0;
  visibility:hidden;
  transition:opacity 0.4s ease;
}
#lightbox.show{
  opacity:1;
  visibility:visible;
}
#lightbox img{
  max-width:90%;
  max-height:90%;
  object-fit:contain;
  border-radius:12px;
  transform:scale(0.9);
  transition: transform 0.3s ease;
}
#lightbox.show img{
  transform:scale(1);
}
.skeleton{background:#ddd;border-radius:12px;margin-bottom:12px;height:16px;position:relative;overflow:hidden;}
.skeleton::before{content:""; display:block; position:absolute; top:0; left:-150px; height:100%; width:150px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation:skeleton-loading 1.2s infinite;}
@keyframes skeleton-loading{0%{left:-150px;}100%{left:100%;}}


/* Plyr播放器样式调整 */
.plyr {
  border-radius: 12px;
  overflow: hidden;
  margin: auto;
  max-height: 100%; 
  min-height: 100%;
  width: 40%; /* 确保宽度适应容器 */
}

/* 确保视频画面按比例缩放并完整显示 */
.plyr__video-wrapper {
  max-height: 100%; /* 减去控件高度 */
  display: flex;
  align-items: center;
  justify-content: center;
}

.plyr__video-wrapper video {
  object-fit: contain !important; /* 保持比例并完整显示 */
  max-height: 100%;
  width: 100%;
}

/* 使媒体控件居中显示 */
.plyr__controls {
  justify-content: center !important;
}

/* 暗黑模式下的Plyr样式 */
[data-theme="dark"] .plyr {
  --plyr-color-main: var(--accent);
  --plyr-video-control-color: #fff;
  --plyr-video-control-color-hover: #fff;
  --plyr-video-control-background-hover: rgba(255,255,255,0.1);
  --plyr-menu-background: #2d2d2d;
  --plyr-menu-color: #eee;
  --plyr-menu-background-hover: rgba(255,255,255,0.05);
}

/* 表格样式 */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

th, td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid rgba(0,0,0,0.1);
}

th {
  background-color: rgba(0, 123, 255, 0.1);
  font-weight: 600;
}

/* 列表样式 */
ul, ol {
  margin: 15px 0;
  padding-left: 25px;
}

li {
  margin: 8px 0;
  padding-left: 5px;
}

ul li::marker {
  color: var(--accent);
}

/* 代码块样式 */
code[class*="language-"] {
  font-size: 0.95rem;
}

/* 添加上一篇下一篇导航样式 */
.navigation { 
  display: flex;
  justify-content: space-between;
  margin-top: 40px;
  padding: 20px 0;
  border-top: 1px solid rgba(0,0,0,0.1);
}

.nav-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  background: var(--card-bg);
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.nav-button:hover {
  background: var(--accent);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.nav-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.nav-button.hidden {
  display: none;
}

.nav-button i {
  font-size: 18px;
}

@media(max-width:768px) {
  body{padding:12px;}
  header{
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    flex-wrap:nowrap; /* 禁止换行 */
  }
  header h1{
    font-size:18px;
    flex-grow: 1;
    text-align: center;
    margin: 0 5px;
    max-width: calc(100% - 100px); /* 移动端调整最大宽度 */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  article{padding:20px;border-radius:12px;}
  article h1{font-size:1.6rem;}
  article p { font-size: 1rem; }
  .plyr { margin: 15px 0; }
  article img {
    width: 100%;
  }
  /* 隐藏按钮文字 */
  .btn-text {
    display: none;
  }
  /* 调整按钮样式 */
  header button {
    padding: 8px; /* 增加点击区域 */
    min-width: 40px; /* 确保按钮宽度足够 */
    justify-content: center; /* 图标居中 */
  }
   .plyr {
    margin: 15px auto; /* 改为auto使播放器居中 */
    width: 100%; /* 移动端宽度调整为90% */
  }
  
  /* 移动端滚动效果更明显 */
  header.scrolled {
    padding: 5px 10px;
  }
  
  header.scrolled h1 {
    font-size: 16px;
    transform: scale(0.85);
  }
  
  header.scrolled button {
    padding: 4px 8px;
  }
  
  /* 移动端导航样式 */
  .navigation {
    flex-direction: column;
    gap: 10px;
  }
  
  .nav-button {
    justify-content: center;
  }
}

@media(max-width:480px){
  article {
    padding: 15px;
  }
  article h1 { font-size: 1.4rem; }
  article h2 { font-size: 1.3rem; }
  header h1 {
    font-size: 16px; /* 进一步缩小标题 */
  }
  
  /* 移动端滚动效果 */
  header.scrolled h1 {
    font-size: 14px;
  }
}
</style>
</head>
<body data-theme="light">
<div class="content-container">
  <header>
    <div class="header-left">
      <button onclick="navigateBack()"><i class="bi bi-house"></i> <span class="btn-text">返回主页</span></button>
    </div>
    <h1 id="pageTitle">Tang.café</h1>
    <button class="toggle"><i class="bi bi-moon-stars"></i> <span class="btn-text">暗黑模式</span></button>
  </header>

  <article id="postContent">
    <div class="skeleton" style="width:60%;height:24px;margin-bottom:12px;"></div>
    <div class="skeleton" style="width:30%;height:16px;margin-bottom:12px;"></div>
    <div class="skeleton" style="width:100%;height:16px;margin-bottom:6px;"></div>
    <div class="skeleton" style="width:90%;height:16px;margin-bottom:6px;"></div>
    <div class="skeleton" style="width:80%;height:16px;margin-bottom:6px;"></div>
  </article>
  
  <!-- 添加导航按钮容器 -->
  <div class="navigation">
    <button id="prevPost" class="nav-button hidden">
      <i class="bi bi-arrow-left"></i>
      <span class="btn-text">上一篇</span>
    </button>
    <button id="nextPost" class="nav-button hidden">
      <span class="btn-text">下一篇</span>
      <i class="bi bi-arrow-right"></i>
    </button>
  </div>
</div>

<div id="lightbox"></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- 引入Plyr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.polyfilled.min.js"></script>
<script>
// 添加滚动监听实现头部缩小效果
function initHeaderScrollEffect() {
  const header = document.querySelector('header');
  const scrollThreshold = 60; // 滚动多少距离后开始缩小
  
  window.addEventListener('scroll', () => {
    if (window.scrollY > scrollThreshold) {
      header.classList.add('scrolled');
    } else {
      header.classList.remove('scrolled');
    }
  });
  
  // 初始检查
  if (window.scrollY > scrollThreshold) {
    header.classList.add('scrolled');
  }
}

// 主题切换
function updateThemeUI(theme){
  document.body.setAttribute('data-theme',theme);
  document.querySelectorAll('.toggle').forEach(btn=>{
    // 修改按钮HTML结构，添加span标签包裹文字
    btn.innerHTML = theme==='dark' ? 
      '<i class="bi bi-sun-fill"></i> <span class="btn-text">浅色模式</span>' : 
      '<i class="bi bi-moon-stars"></i> <span class="btn-text">暗黑模式</span>';
  });
}
function loadTheme(){
  const savedTheme = localStorage.getItem('theme')||'light';
  updateThemeUI(savedTheme);
}
loadTheme();
document.querySelectorAll('.toggle').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const current=document.body.getAttribute('data-theme')==='dark'?'light':'dark';
    updateThemeUI(current);
    localStorage.setItem('theme',current);
  });
});

// 工具函数
function highlightKeyword(text,keyword){if(!keyword)return text;const regex=new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');return text.replace(regex,'<mark>$1</mark>');}
function getQuery(name){return new URLSearchParams(window.location.search).get(name);}

// 新增返回函数
function navigateBack() {
  window.location.href = './';
}
const id=getQuery('id'), keyword=getQuery('keyword')||'', articleEl=document.getElementById('postContent');
const prevBtn = document.getElementById('prevPost');
const nextBtn = document.getElementById('nextPost');
let allPosts = []; // 存储所有文章的ID和标题

// 加载所有文章的ID（用于导航）
async function loadAllPostIds() {
  try {
    const res = await fetch('https://api.tang.cafe/api/v1?pagenum=1&pageSize=1000'); // 获取所有文章（假设不超过1000篇）
    const data = await res.json();
    if (data.success && data.data) {
      // 按日期排序（最新的在前）
      allPosts = data.data.sort((a, b) => new Date(b.日期) - new Date(a.日期))
        .map(post => ({ id: post.填写ID, title: post.标题 }));
      
      // 设置导航按钮状态
      updateNavigationButtons();
    }
  } catch(e) {
    console.error('加载文章列表失败:', e);
  }
}

// 更新导航按钮状态
function updateNavigationButtons() {
  const currentIndex = allPosts.findIndex(post => post.id === id);
  
  if (currentIndex === -1) {
    // 当前文章不在列表中，隐藏所有导航按钮
    prevBtn.classList.add('hidden');
    nextBtn.classList.add('hidden');
    return;
  }
  
  // 设置上一篇按钮
  if (currentIndex > 0) {
    const prevPost = allPosts[currentIndex - 1];
    prevBtn.classList.remove('hidden');
    prevBtn.onclick = () => {
      window.location.href = `post.html?id=${prevPost.id}${keyword ? '&keyword=' + encodeURIComponent(keyword) : ''}`;
    };
    prevBtn.title = `上一篇: ${prevPost.title}`;
  } else {
    prevBtn.classList.add('hidden'); // 第一篇文章，隐藏上一篇按钮
  }
  
  // 设置下一篇按钮
  if (currentIndex < allPosts.length - 1) {
    const nextPost = allPosts[currentIndex + 1];
    nextBtn.classList.remove('hidden');
    nextBtn.onclick = () => {
      window.location.href = `post.html?id=${nextPost.id}${keyword ? '&keyword=' + encodeURIComponent(keyword) : ''}`;
    };
    nextBtn.title = `下一篇: ${nextPost.title}`;
  } else {
    nextBtn.classList.add('hidden'); // 最后一篇文章，隐藏下一篇按钮
  }
}

// 加载文章
async function loadPost() {
  try{
    const res=await fetch(`https://api.tang.cafe/api/v1?id=${id}`);
    const data=await res.json();
    if(data.success && data.data){
      const post=data.data;
      
      // 使用自定义渲染器优化Markdown
      const renderer = new marked.Renderer();
      
      // 优化表格渲染
      renderer.table = (header, body) => {
        return `<table><thead>${header}</thead><tbody>${body}</tbody></table>`;
      };
      
      // 优化代码块
      renderer.code = (code, language) => {
        const validLang = !language ? '' : language;
        return `<pre><code class="language-${validLang}">${code}</code></pre>`;
      };
      
      // 设置Marked选项
      marked.setOptions({
        renderer,
        gfm: true,
        breaks: true,
        smartLists: true,
        smartypants: true
      });
      
      articleEl.innerHTML=`
        <h1><i class="bi bi-file-earmark-text"></i> ${highlightKeyword(post.标题,keyword)}</h1>
        <div class="post-date"><i class="bi bi-clock"></i> ${new Date(post.日期).toLocaleDateString()}</div>
        <div class="markdown-body">${highlightKeyword(marked.parse(post.文章内容),keyword)}</div>
      `;

      // 设置页面标题
      document.title = post.标题;
      document.getElementById('pageTitle').innerHTML = `${post.标题}`;

      // 图片懒加载 + Lightbox
      const imgs = articleEl.querySelectorAll("img");
      const lightbox = document.getElementById("lightbox");
      const imgArray = Array.from(imgs); // 存储所有图片到数组
      let currentImgIndex = 0; // 当前查看的图片索引

      // 更新lightbox显示的图片
      function updateLightboxImage(index) {
        lightbox.innerHTML = '';
        const clone = document.createElement("img");
        clone.src = imgArray[index].src;
        lightbox.appendChild(clone);
        lightbox.classList.add("show");
        currentImgIndex = index;
        addNavigationButtons(); // 更新图片后重新添加导航按钮
      }

      imgs.forEach((img, index)=>{
        img.loading="lazy";
        img.addEventListener("load",()=>{img.style.opacity=1;});
        img.addEventListener("click", ()=>{
          updateLightboxImage(index);
        });
      });

      // 添加左右滑动功能
      lightbox.addEventListener("click", e=>{
        if(e.target===lightbox){
          lightbox.classList.remove("show");
        }
      });

      // 添加左右箭头按钮
      function addNavigationButtons() {
        // 检查是否为移动端 (宽度 <= 768px)
        if (window.innerWidth <= 768) {
          return; // 在移动端不添加箭头按钮
        }
      
        // 左箭头
        const leftBtn = document.createElement("button");
        leftBtn.className = "lightbox-btn left-btn";
        leftBtn.innerHTML = '<i class="bi bi-chevron-left"></i>';
        leftBtn.style.position = 'absolute';
        leftBtn.style.top = '50%';
        leftBtn.style.left = '20px';
        leftBtn.style.transform = 'translateY(-50%)';
        leftBtn.style.backgroundColor = 'rgba(0,0,0,0.5)';
        leftBtn.style.color = 'white';
        leftBtn.style.border = 'none';
        leftBtn.style.borderRadius = '50%';
        leftBtn.style.width = '50px';
        leftBtn.style.height = '50px';
        leftBtn.style.fontSize = '24px';
        leftBtn.style.cursor = 'pointer';
        leftBtn.style.zIndex = '10001';
        leftBtn.addEventListener('click', () => {
          currentImgIndex = (currentImgIndex - 1 + imgArray.length) % imgArray.length;
          updateLightboxImage(currentImgIndex);
        });
      
        // 右箭头
        const rightBtn = document.createElement("button");
        rightBtn.className = "lightbox-btn right-btn";
        rightBtn.innerHTML = '<i class="bi bi-chevron-right"></i>';
        rightBtn.style.position = 'absolute';
        rightBtn.style.top = '50%';
        rightBtn.style.right = '20px';
        rightBtn.style.transform = 'translateY(-50%)';
        rightBtn.style.backgroundColor = 'rgba(0,0,0,0.5)';
        rightBtn.style.color = 'white';
        rightBtn.style.border = 'none';
        rightBtn.style.borderRadius = '50%';
        rightBtn.style.width = '50px';
        rightBtn.style.height = '50px';
        rightBtn.style.fontSize = '24px';
        rightBtn.style.cursor = 'pointer';
        rightBtn.style.zIndex = '10001';
        rightBtn.addEventListener('click', () => {
          currentImgIndex = (currentImgIndex + 1) % imgArray.length;
          updateLightboxImage(currentImgIndex);
        });
      
        lightbox.appendChild(leftBtn);
        lightbox.appendChild(rightBtn);
      }
      addNavigationButtons();

      // 触摸滑动支持
      let touchStartX = null;
      lightbox.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].screenX;
      }, false);

      lightbox.addEventListener('touchend', (e) => {
        if (!touchStartX) return;
        const touchEndX = e.changedTouches[0].screenX;
        const diff = touchEndX - touchStartX;

        // 检测滑动方向和距离
        if (diff > 50) {
          // 向右滑动，显示上一张
          currentImgIndex = (currentImgIndex - 1 + imgArray.length) % imgArray.length;
          updateLightboxImage(currentImgIndex);
        } else if (diff < -50) {
          // 向左滑动，显示下一张
          currentImgIndex = (currentImgIndex + 1) % imgArray.length;
          updateLightboxImage(currentImgIndex);
        }

        touchStartX = null;
      }, false);
      // 初始化Plyr播放器
      setTimeout(() => {
        // 初始化视频和音频播放器
        const players = Plyr.setup('video, audio', {
          controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
          settings: ['quality', 'speed'],
          load: 'auto'
        });
        
        // 先检查players是否存在，再检查长度
        if (players && players.length > 0) {
          // 更新播放器主题
          function updatePlayerTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            players.forEach(player => {
              player.elements.container.classList.toggle('plyr--dark', isDark);
            });
          }
          
          // 初始设置主题
          updatePlayerTheme();
          
          // 监听主题变化
          const observer = new MutationObserver(() => {
            updatePlayerTheme();
          });
          
          observer.observe(document.body, {
            attributes: true,
            attributeFilter: ['data-theme']
          });
        }
      }, 100);
      
      // 加载完成后获取所有文章ID用于导航
      loadAllPostIds();
      
  }else{articleEl.innerHTML='<p>未找到文章</p>';}
  }catch(e){
    console.error(e);
    articleEl.innerHTML='<p>加载失败，请稍后重试</p>';
  }
}
// 监听窗口大小变化
window.addEventListener('resize', () => {
  // 如果lightbox当前显示中
  const lightbox = document.getElementById('lightbox');
  if (lightbox.classList.contains('show')) {
    // 重新创建导航按钮
    lightbox.innerHTML = '';
    const clone = document.createElement("img");
    clone.src = imgArray[currentImgIndex].src;
    lightbox.appendChild(clone);
    addNavigationButtons();
  }
});

// 初始化头部滚动效果
initHeaderScrollEffect();

// 加载文章内容
loadPost();
</script>
</body>
</html>
