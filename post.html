<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文章详情</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<style>
:root{
  --bg:linear-gradient(135deg,#f5f7fa,#c3cfe2);
  --text:#111;
  --card-bg:rgba(255,255,255,0.95);
  --card-shadow:rgba(0,0,0,0.1);
  --accent:#007bff;
  --highlight:#ffd54f;
  --skeleton-bg:#ddd;
  --link:#0066cc;
  --blockquote:#f9f9f9;
  --code-bg:#f5f2f0;
}
[data-theme="dark"]{
  --bg:linear-gradient(135deg,#1e1e1e,#2c2c2c);
  --text:#eee;
  --card-bg:rgba(30,30,30,0.9);
  --card-shadow:rgba(0,0,0,0.6);
  --accent:#4da6ff;
  --highlight:#ffab40;
  --skeleton-bg:#333;
  --link:#4da6ff;
  --blockquote:#2a2a2a;
  --code-bg:#1e1e1e;
}
body{
  background:var(--bg);
  color:var(--text);
  font-family:'Segoe UI',Arial,sans-serif;
  margin:0;padding:20px;
  transition:background 0.3s,color 0.3s;
  line-height:1.75;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
  gap:10px;
  flex-wrap:wrap;
}
header button{
  cursor:pointer;
  padding:6px 12px;
  border-radius:6px;
  border:0px solid var(--text);
  background:var(--card-bg);
  backdrop-filter:blur(5px);
  display:flex;align-items:center;gap:5px;
  color:var(--text);
  transition:all 0.3s;
}
header button:hover{
  background:var(--accent);
  color:#fff;
}
article{
  background:var(--card-bg);
  padding:30px;
  border-radius:16px;
  box-shadow:0 6px 16px var(--card-shadow);
  color:var(--text);
  overflow:hidden;
}
/* Markdown 美化 */
article h1,article h2,article h3,article h4{
  margin:20px 0 12px;
  font-weight:600;
}
article p{margin:12px 0;}
article a{color:var(--link);text-decoration:none;}
article a:hover{text-decoration:underline;}
article blockquote{
  border-left:4px solid var(--accent);
  padding-left:12px;
  color:var(--text);
  background:var(--blockquote);
  border-radius:6px;
  margin:15px 0;
}
article pre, article code{
  background:var(--code-bg);
  border-radius:6px;
  padding:6px 10px;
  font-family:monospace;
  overflow-x:auto;
  color:var(--accent);
}
article pre{padding:14px;}
/* 图片增强 */
article img{
  max-width:100%;
  border-radius:12px;
  margin:15px 0;
  display:block;
  cursor:zoom-in;
  transition:transform 0.3s;
}
article img:hover{transform:scale(1.03);}

/* 图片灯箱 */
#lightbox{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.85);
  display:none;align-items:center;justify-content:center;
  z-index:9999;
}
#lightbox img{
  max-width:90%;max-height:90%;
  border-radius:12px;
  box-shadow:0 0 20px rgba(0,0,0,0.6);
}
#lightbox:target{display:flex;}

/* skeleton */
mark{background-color:var(--highlight);color:inherit;padding:0 2px;border-radius:2px;}
.skeleton{background: var(--skeleton-bg); border-radius: 12px; margin-bottom:12px; position: relative; overflow: hidden; height:16px;}
.skeleton::before{content:""; display:block; position:absolute; top:0; left:-150px; height:100%; width:150px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation:skeleton-loading 1.2s infinite;}
@keyframes skeleton-loading{0%{left:-150px;}100%{left:100%;}}

/* 图片画廊 */
.image-gallery {
  display:flex;
  overflow-x:auto;
  gap:12px;
  padding:10px 0;
  scroll-snap-type:x mandatory;
}
.image-gallery img {
  flex:0 0 auto;
  height:220px;
  border-radius:12px;
  object-fit:cover;
  cursor:zoom-in;
  transition:transform 0.3s, opacity 0.5s;
  scroll-snap-align:start;
  opacity:0;
}
.image-gallery img.visible{
  opacity:1;
  transform:scale(1);
}
.image-gallery img:hover{transform:scale(1.05);}
.image-gallery::-webkit-scrollbar{height:6px;}
.image-gallery::-webkit-scrollbar-thumb{background:var(--accent);border-radius:3px;}

/* 响应式 */
@media (max-width: 768px) {
  body{padding:12px;}
  header{flex-direction:column;align-items:flex-start;gap:8px;}
  header h1{font-size:22px;}
  article{padding:20px;border-radius:12px;}
  article h1{font-size:22px;}
  .post-date{font-size:12px;}
}
h1{font-size:28px;margin-bottom:15px;display:flex;align-items:center;gap:8px;}
.post-date{font-size:13px;color:#888;margin-bottom:20px;display:flex;align-items:center;gap:5px;}
</style>
</head>
<body data-theme="light">
<header>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <button onclick="window.history.back()"><i class="bi bi-arrow-left-circle"></i> 返回</button>
    <button class="toggle"><i class="bi bi-moon-stars"></i> 暗黑模式</button>
  </div>
  <h1><i class="bi bi-journal-text"></i> 文章详情</h1>
</header>

<article id="postContent">
  <div class="skeleton" style="width:60%;height:24px;margin-bottom:12px;"></div>
  <div class="skeleton" style="width:30%;height:16px;margin-bottom:12px;"></div>
  <div class="skeleton" style="width:100%;height:16px;margin-bottom:6px;"></div>
  <div class="skeleton" style="width:90%;height:16px;margin-bottom:6px;"></div>
  <div class="skeleton" style="width:80%;height:16px;margin-bottom:6px;"></div>
</article>

<div id="lightbox"><img src="" alt=""></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// ====== 主题持久化 & 图标文字同步 ======
function updateThemeUI(theme){
  document.body.setAttribute('data-theme',theme);
  document.querySelectorAll('.toggle').forEach(btn=>{
    if(theme==='dark'){
      btn.innerHTML='<i class="bi bi-sun-fill"></i> 浅色模式';
    }else{
      btn.innerHTML='<i class="bi bi-moon-stars"></i> 暗黑模式';
    }
  });
}
function loadTheme(){
  const savedTheme=localStorage.getItem('theme') || 'light';
  updateThemeUI(savedTheme);
}
loadTheme();
document.querySelectorAll('.toggle').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const current=document.body.getAttribute('data-theme')==='dark'?'light':'dark';
    updateThemeUI(current);
    localStorage.setItem('theme',current);
  });
});

// ====== 工具函数 ======
function highlightKeyword(text, keyword){
  if(!keyword) return text;
  const regex=new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');
  return text.replace(regex,'<mark>$1</mark>');
}
function getQuery(name){const params=new URLSearchParams(window.location.search);return params.get(name);}
const id=getQuery('id'), keyword=getQuery('keyword')||'', articleEl=document.getElementById('postContent');

// ====== 加载文章 ======
async function loadPost(){
  try{
    const res=await fetch(`https://api.tang.cafe/api/v1?id=${id}`);
    const data=await res.json();
    if(data.success && data.data){
      const post=data.data;
      articleEl.innerHTML=`
        <h1><i class="bi bi-file-earmark-text"></i> ${highlightKeyword(post.标题,keyword)}</h1>
        <div class="post-date"><i class="bi bi-clock"></i> ${new Date(post.日期).toLocaleDateString()}</div>
        <div class="markdown-body">${highlightKeyword(marked.parse(post.文章内容),keyword)}</div>
      `;

      // 图片处理
      const images = articleEl.querySelectorAll("img");
      if(images.length>0){
        const gallery = document.createElement("div");
        gallery.className = "image-gallery";
        images.forEach(img=>{
          img.loading="lazy";
          gallery.appendChild(img);
        });
        articleEl.querySelectorAll("img").forEach(i=>i.remove());
        articleEl.appendChild(gallery);

        // 懒加载动画
        const observer = new IntersectionObserver(entries=>{
          entries.forEach(entry=>{
            if(entry.isIntersecting){
              entry.target.classList.add("visible");
              observer.unobserve(entry.target);
            }
          });
        },{threshold:0.1});
        gallery.querySelectorAll("img").forEach(img=>observer.observe(img));

        // 点击灯箱
        gallery.querySelectorAll("img").forEach(img=>{
          img.addEventListener("click",()=>{
            const lightbox=document.getElementById("lightbox");
            lightbox.style.display="flex";
            lightbox.querySelector("img").src=img.src;
          });
        });
      }

      document.getElementById("lightbox").addEventListener("click",()=>{
        document.getElementById("lightbox").style.display="none";
      });

    }else{
      articleEl.innerHTML='<p>未找到文章</p>';
    }
  }catch(e){
    articleEl.innerHTML='<p>加载失败，请稍后重试</p>';
  }
}
loadPost();
</script>
</body>
</html>
