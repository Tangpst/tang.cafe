<!DOCTYPE html>
<html lang="zh">
<head>
<link rel="icon" href="./favicon.svg" type="image/svg+xml">
<link rel="icon" href="./favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tang.cafÃ©</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<style>  

/* åŸæœ‰åª’ä½“æŸ¥è¯¢ä¿æŒä¸å˜ */
</style>
</head>
<body data-theme="light">
<header>
  <h1 id="siteTitle" style="cursor: pointer; transition: transform 0.2s ease;"><i class="bi bi-cup-hot"></i>Tang.cafÃ©</h1>
  <div class="header-controls">
    <div class="search-wrapper">
      <input id="searchInput" type="text" placeholder="æœç´¢æ–‡ç« ..." />
      <button id="clearSearchBtn" class="clear-btn"><i class="bi bi-x-lg"></i></button>
    </div>
    <button id="searchBtn"><i class="bi bi-search"></i></button>
    <button class="toggle"><i class="bi bi-moon-stars"></i> æš—é»‘æ¨¡å¼</button>
  </div>
</header>

<!-- æ·»åŠ å®¹å™¨åŒ…è£¹å†…å®¹åŒºåŸŸ -->
<div id="posts-container">
  <div id="posts"></div>
  <div id="loading"><div class="coffee_cup"></div></div>
  <div id="endOfContent" class="end-of-content" style="display:none;">åˆ°åº•äº†ï¼Œåˆ«æ‹‰äº†ğŸ˜…</div>
</div>



<script>
// æ¢å¤isLoadingæ ‡å¿—
let currentPage=1, pageSize=10, currentKeyword='', hasMore=true, isLoading=false;
const postsContainer=document.getElementById('posts');
const loadingDiv=document.getElementById('loading');
const endOfContentDiv=document.getElementById('endOfContent');
const siteTitle = document.getElementById('siteTitle');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearchBtn = document.getElementById('clearSearchBtn'); // æ–°å¢


// ====== æ¸…é™¤æŒ‰é’®åŠŸèƒ½ ======
function updateClearButtonVisibility() {
  clearSearchBtn.style.display = searchInput.value.trim() ? 'block' : 'none';
}

// æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
clearSearchBtn.addEventListener('click', () => {
  // æ¸…é™¤æœç´¢æ¡†å†…å®¹
  searchInput.value = '';
  updateClearButtonVisibility();
  
  // é€€å‡ºæœç´¢çŠ¶æ€ä½†ä¸æ¸…é™¤ç°æœ‰å†…å®¹
  if (currentKeyword) {
    currentKeyword = '';
    // ç¡®ä¿æ ‡é¢˜åœ¨ç§»åŠ¨ç«¯å¯è§
    if (window.innerWidth <= 768) {
      siteTitle.classList.remove('hidden');
    }
    // ä¿ç•™å½“å‰å†…å®¹ï¼Œåªæ¸…é™¤æœç´¢çŠ¶æ€
    currentPage = 1;
    hasMore = true;
    postsContainer.innerHTML = '';
    endOfContentDiv.style.display = 'none';
    loadPosts('');
  }
});

// ====== æœç´¢æ¡†åŠŸèƒ½ ======

// åˆå§‹åŒ–æœç´¢æŒ‰é’®çŠ¶æ€
function updateSearchButtonState() {
  const value = searchInput.value.trim();
  searchBtn.disabled = false; // ä¿®æ”¹ï¼šå§‹ç»ˆå¯ç”¨æœç´¢æŒ‰é’®
  updateClearButtonVisibility(); // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
}

// åˆå§‹æ£€æŸ¥
updateSearchButtonState();

// ç›‘å¬æœç´¢æ¡†è¾“å…¥å˜åŒ–
searchInput.addEventListener('input', updateSearchButtonState);

// æœç´¢æ¡†å¤±å»ç„¦ç‚¹ä¸”æ— å†…å®¹æ—¶ï¼Œæ¢å¤ä¸ºçŸ­æœç´¢æ¡†
searchInput.addEventListener('blur', () => {
  if (searchInput.value.trim().length === 0) {
    // ç§»é™¤ç„¦ç‚¹æ ·å¼ï¼Œä½†ä¿æŒæ˜¾ç¤º
    searchInput.blur();
    // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œæ˜¾ç¤ºæ ‡é¢˜
    if (window.innerWidth <= 768) {
      siteTitle.classList.remove('hidden');
    }
  }
});

// æ·»åŠ æœç´¢æ¡†èšç„¦äº‹ä»¶ç›‘å¬å™¨ - ç§»åŠ¨ç«¯éšè—æ ‡é¢˜
searchInput.addEventListener('focus', () => {
  // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
  if (window.innerWidth <= 768) {
    siteTitle.classList.add('hidden');
  }
  updateClearButtonVisibility(); // ç¡®ä¿æ¸…é™¤æŒ‰é’®å¯è§æ€§æ­£ç¡®
});

// æ·»åŠ çª—å£å¤§å°å˜åŒ–äº‹ä»¶ç›‘å¬å™¨ - ç¡®ä¿åœ¨çª—å£å¤§å°å˜åŒ–æ—¶æ­£ç¡®æ˜¾ç¤º/éšè—æ ‡é¢˜
window.addEventListener('resize', () => {
  // å¦‚æœä¸æ˜¯ç§»åŠ¨ç«¯ï¼Œç¡®ä¿æ ‡é¢˜å¯è§
  if (window.innerWidth > 768) {
    siteTitle.classList.remove('hidden');
  } else if (searchInput.value.trim().length === 0 && document.activeElement !== searchInput) {
    // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œæœç´¢æ¡†ä¸ºç©ºï¼Œä¸”æœç´¢æ¡†æœªèšç„¦ï¼Œåˆ™æ˜¾ç¤ºæ ‡é¢˜
    siteTitle.classList.remove('hidden');
  }
});

// ====== æ ‡é¢˜ç‚¹å‡»åˆ·æ–°åŠŸèƒ½ ======

siteTitle.addEventListener('click', () => {
  // æ¸…é™¤æœç´¢æ¡†å†…å®¹
  searchInput.value = '';
  updateClearButtonVisibility();
  // åˆ·æ–°å†…å®¹
  doSearch();
  // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
  siteTitle.style.transform = 'scale(0.95)';
  setTimeout(() => {
    siteTitle.style.transform = 'scale(1)';
  }, 200);
  // ç¡®ä¿æ ‡é¢˜å¯è§
  siteTitle.classList.remove('hidden');
});

// æ·»åŠ æ‚¬åœæ•ˆæœå¢å¼º
siteTitle.addEventListener('mouseover', () => {
  siteTitle.style.transform = 'scale(1.03)';
});

siteTitle.addEventListener('mouseout', () => {
  siteTitle.style.transform = 'scale(1)';
});

// ====== ä¸»é¢˜æŒä¹…åŒ– & å›¾æ ‡æ–‡å­—åŒæ­¥ ======
function updateThemeUI(theme){
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('.toggle').forEach(btn => {
    if(theme === 'dark'){
      btn.innerHTML='<i class="bi bi-sun-fill"></i><span> æµ…è‰²æ¨¡å¼</span>';
    } else {
      btn.innerHTML='<i class="bi bi-moon-stars"></i><span> æš—é»‘æ¨¡å¼</span>';
    }
  });
}

function loadTheme(){
  const savedTheme = localStorage.getItem('theme') || 'light';
  updateThemeUI(savedTheme);
}

loadTheme();

// ç›‘å¬storageäº‹ä»¶
window.addEventListener('storage', (e) => {
  if (e.key === 'theme') {
    updateThemeUI(e.newValue || 'light');
  }
});

// ä¿®æ”¹ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
document.querySelectorAll('.toggle').forEach(btn => {
  btn.addEventListener('click', () => {
    const current = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    updateThemeUI(current);
    localStorage.setItem('theme', current);
  });
});   

// ====== å·¥å…·å‡½æ•° ======
function highlightKeyword(text,keyword){
  if(!keyword) return text;
  const regex=new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');
  return text.replace(regex,'<mark>$1</mark>');
}

// æ”¹è¿›çš„æ‘˜è¦æå–å‡½æ•° - å½»åº•ç§»é™¤æ‰€æœ‰åª’ä½“å†…å®¹
function extractSummary(text){
  // åˆ›å»ºä¸´æ—¶å…ƒç´ ç”¨äºè§£æHTML
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = text;
  
  // ç§»é™¤æ‰€æœ‰åª’ä½“å…ƒç´ 
  tempDiv.querySelectorAll('img, video, audio, iframe, picture, source, track').forEach(el => el.remove());
  
  // è·å–çº¯æ–‡æœ¬å†…å®¹
  let cleanText = tempDiv.textContent || tempDiv.innerText || '';
  
  // é¢å¤–å¤„ç†Markdownå›¾ç‰‡è¯­æ³•
  cleanText = cleanText.replace(/!\[.*?\]\(.*?\)/g, '');
  
  // ç§»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
  cleanText = cleanText.replace(/\s+/g, ' ').trim();
  
  return cleanText.slice(0, 140);
}


function showSkeleton(count=3){
  for(let i=0;i<count;i++){
    const sk=document.createElement('div');
    sk.className='post visible';
    sk.innerHTML=`
      <div class="skeleton" style="height:20px;width:60%;margin-bottom:8px;"></div>
      <div class="skeleton" style="height:14px;width:30%;margin-bottom:12px;"></div>
      <div class="skeleton" style="height:16px;width:100%;margin-bottom:6px;"></div>
      <div class="skeleton" style="height:16px;width:90%;margin-bottom:6px;"></div>
      <div class="skeleton" style="height:16px;width:80%;margin-bottom:6px;"></div>
    `;
    postsContainer.appendChild(sk);
  }
}

// ====== åŠ è½½æ–‡ç«  ======
async function loadPosts(keyword='') {
  // æ¢å¤å¯¹isLoadingçš„æ£€æŸ¥
  if (!hasMore || isLoading) return;
  
  // è®¾ç½®åŠ è½½é”ä¸ºtrue
  isLoading = true;
  
  showSkeleton();
  loadingDiv.style.display='block';
  endOfContentDiv.style.display='none';
  
  try {
    const res = await fetch(`https://api.tang.cafe/api/v1?pagenum=${currentPage}&pageSize=${pageSize}&keyword=${encodeURIComponent(keyword)}`);
    const data = await res.json();
    loadingDiv.style.display='none';
    document.querySelectorAll('.skeleton').forEach(s=>s.parentNode.remove());

    if (data.success && data.data && data.data.length>0) {
      data.data.forEach((post,index)=>{
        const div=document.createElement('div');
        div.className='post';
        div.style.transitionDelay=`${index*100}ms`;
        div.innerHTML=`
          <div class="post-title" onclick="window.location.href='post.html?id=${post.å¡«å†™ID}&keyword=${encodeURIComponent(keyword)}'">
            <i class="bi bi-file-earmark-text"></i> ${highlightKeyword(post.æ ‡é¢˜,keyword)}
          </div>
          <div class="post-date"><i class="bi bi-clock"></i> ${new Date(post.æ—¥æœŸ).toLocaleDateString()}</div>
          <div class="post-summary">${highlightKeyword(extractSummary(post.æ–‡ç« å†…å®¹),keyword)}...</div>
        `;
        postsContainer.appendChild(div);
        setTimeout(()=>div.classList.add('visible'),50);
      });
      
      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
      if (data.data.length < pageSize) {
        hasMore = false;
        endOfContentDiv.style.display = 'block';
      }
      
      currentPage++;
    } else if (currentPage===1) {
      postsContainer.innerHTML='<p>æœªæ‰¾åˆ°ç›¸å…³æ–‡ç« </p>';
      hasMore = false;
    } else {
      hasMore = false;
      endOfContentDiv.style.display = 'block';
    }
  } catch(e){
    loadingDiv.style.display='none';
    alert('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  } finally {
    // ç¡®ä¿æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒisLoadingéƒ½ä¼šè¢«é‡ç½®ä¸ºfalse
    isLoading = false;
  }
}

// ====== æœç´¢ ======
function doSearch(){
  postsContainer.innerHTML='';
  currentPage=1;
  hasMore = true;
  currentKeyword=document.getElementById('searchInput').value.trim();
  endOfContentDiv.style.display = 'none';
  updateClearButtonVisibility(); // æ›´æ–°æ¸…é™¤æŒ‰é’®çŠ¶æ€
  loadPosts(currentKeyword);
}
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter') doSearch();});
// æ·»åŠ æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
document.getElementById('searchBtn').addEventListener('click', doSearch);

// ====== æ»šåŠ¨äº‹ä»¶å¤„ç† ======
window.addEventListener('scroll',()=>{
  // æ— é™æ»šåŠ¨
  if(hasMore && !isLoading && window.innerHeight + window.scrollY >= document.body.offsetHeight - 50){
    loadPosts(currentKeyword);
  }

  // å¤´éƒ¨æ»šåŠ¨æ•ˆæœ
  const header = document.querySelector('header');
  if (window.scrollY > 50) {
      header.classList.add('scrolled');
  } else {
      header.classList.remove('scrolled');
  }
});

// åˆå§‹åŒ–å›åˆ°é¡¶éƒ¨æŒ‰é’®
function initBackToTopButton() {
    // åˆ›å»ºæŒ‰é’®å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    let backToTopBtn = document.getElementById('backToTop');
    if (!backToTopBtn) {
        backToTopBtn = document.createElement('button');
        backToTopBtn.id = 'backToTop';
        document.body.appendChild(backToTopBtn);
    }

    // è®¾ç½®æŒ‰é’®å†…å®¹
    backToTopBtn.innerHTML = `
        <svg viewBox="0 0 1024 1024" width="24" height="24">
            <path d="M351.957333 1015.893333a31.914667 31.914667 0 0 1-31.573333-26.709333L228.864 439.893333H159.957333a32 32 0 0 1 0-64h65.834667a288.213333 288.213333 0 0 1 328.277333-252.928l7.594667-38.869333A95.829333 95.829333 0 0 1 682.154667 11.904l158.677333 45.226667c8.234667 2.346667 15.061333 7.765333 19.2 15.232s5.162667 16.128 2.816 24.32a32.128 32.128 0 0 1-39.594667 22.016l-158.677333-45.226667a32.256 32.256 0 0 0-9.045333-1.28 32.170667 32.170667 0 0 0-31.146667 25.045333l-8.234667 42.24a290.816 290.816 0 0 1 182.144 236.458667h65.792a32 32 0 0 1 0 64H796.586667l-60.842667 547.541333a32 32 0 0 1-31.829333 28.458667H351.957333z m323.370667-64l28.458667-256h-367.36l42.666666 256h296.234667z m35.541333-320l21.333334-192h-174.805334l-37.461333 192h190.933333z m-256.128 0l37.461334-192H293.717333l32 192h129.024z m278.912-256a223.658667 223.658667 0 0 0-130.090666-172.373333l-33.621334 172.373333h163.712z m-228.949333 0l37.077333-190.037333A224.512 224.512 0 0 0 290.346667 375.893333h214.357333z"/>
        </svg>
    `;

    // æ»šåŠ¨äº‹ä»¶ç›‘å¬
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.add('visible');
        } else {
            backToTopBtn.classList.remove('visible');
        }
    });

    // ç‚¹å‡»äº‹ä»¶ç›‘å¬
    backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', initBackToTopButton);

loadPosts();
</script>
</body>
</html>

