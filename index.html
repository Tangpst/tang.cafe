<!DOCTYPE html>
<html lang="zh">
<head>
<link rel="icon" href="./favicon.svg" type="image/svg+xml">
<link rel="icon" href="./favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tang.café</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<style>  

/* 原有媒体查询保持不变 */
</style>
</head>
<body data-theme="light">
<header>
  <h1 id="siteTitle" style="cursor: pointer; transition: transform 0.2s ease;"><i class="bi bi-cup-hot"></i>Tang.café</h1>
  <div class="header-controls">
    <div class="search-wrapper">
      <input id="searchInput" type="text" placeholder="搜索文章..." />
      <button id="clearSearchBtn" class="clear-btn"><i class="bi bi-x-lg"></i></button>
    </div>
    <button id="searchBtn"><i class="bi bi-search"></i></button>
    <button class="toggle"><i class="bi bi-moon-stars"></i> 暗黑模式</button>
  </div>
</header>

<!-- 添加容器包裹内容区域 -->
<div id="posts-container">
  <div id="posts"></div>
  <div id="loading"><div class="coffee_cup"></div></div>
  <div id="endOfContent" class="end-of-content" style="display:none;">到底了，别拉了☕</div>
</div>



<script>
// 恢复isLoading标志
let currentPage=1, pageSize=10, currentKeyword='', hasMore=true, isLoading=false;
const postsContainer=document.getElementById('posts');
const loadingDiv=document.getElementById('loading');
const endOfContentDiv=document.getElementById('endOfContent');
const siteTitle = document.getElementById('siteTitle');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearchBtn = document.getElementById('clearSearchBtn'); // 新增


// ====== 清除按钮功能 ======
function updateClearButtonVisibility() {
  clearSearchBtn.style.display = searchInput.value.trim() ? 'block' : 'none';
}

// 清除按钮点击事件
clearSearchBtn.addEventListener('click', () => {
  // 清除搜索框内容
  searchInput.value = '';
  updateClearButtonVisibility();
  
  // 退出搜索状态但不清除现有内容
  if (currentKeyword) {
    currentKeyword = '';
    // 确保标题在移动端可见
    if (window.innerWidth <= 768) {
      siteTitle.classList.remove('hidden');
    }
    // 保留当前内容，只清除搜索状态
    currentPage = 1;
    hasMore = true;
    postsContainer.innerHTML = '';
    endOfContentDiv.style.display = 'none';
    loadPosts('');
  }
});

// ====== 搜索框功能 ======

// 初始化搜索按钮状态
function updateSearchButtonState() {
  const value = searchInput.value.trim();
  searchBtn.disabled = false; // 修改：始终启用搜索按钮
  updateClearButtonVisibility(); // 更新清除按钮显示状态
}

// 初始检查
updateSearchButtonState();

// 监听搜索框输入变化
searchInput.addEventListener('input', updateSearchButtonState);

// 搜索框失去焦点且无内容时，恢复为短搜索框
searchInput.addEventListener('blur', () => {
  if (searchInput.value.trim().length === 0) {
    // 移除焦点样式，但保持显示
    searchInput.blur();
    // 如果是移动端，显示标题
    if (window.innerWidth <= 768) {
      siteTitle.classList.remove('hidden');
    }
  }
});

// 添加搜索框聚焦事件监听器 - 移动端隐藏标题
searchInput.addEventListener('focus', () => {
  // 检查是否为移动端
  if (window.innerWidth <= 768) {
    siteTitle.classList.add('hidden');
  }
  updateClearButtonVisibility(); // 确保清除按钮可见性正确
});

// 添加窗口大小变化事件监听器 - 确保在窗口大小变化时正确显示/隐藏标题
window.addEventListener('resize', () => {
  // 如果不是移动端，确保标题可见
  if (window.innerWidth > 768) {
    siteTitle.classList.remove('hidden');
  } else if (searchInput.value.trim().length === 0 && document.activeElement !== searchInput) {
    // 如果是移动端，搜索框为空，且搜索框未聚焦，则显示标题
    siteTitle.classList.remove('hidden');
  }
});

// ====== 标题点击刷新功能 ======

siteTitle.addEventListener('click', () => {
  // 清除搜索框内容
  searchInput.value = '';
  updateClearButtonVisibility();
  // 刷新内容
  doSearch();
  // 添加点击动画效果
  siteTitle.style.transform = 'scale(0.95)';
  setTimeout(() => {
    siteTitle.style.transform = 'scale(1)';
  }, 200);
  // 确保标题可见
  siteTitle.classList.remove('hidden');
});

// 添加悬停效果增强
siteTitle.addEventListener('mouseover', () => {
  siteTitle.style.transform = 'scale(1.03)';
});

siteTitle.addEventListener('mouseout', () => {
  siteTitle.style.transform = 'scale(1)';
});

// ====== 主题持久化 & 图标文字同步 ======
function updateThemeUI(theme){
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('.toggle').forEach(btn => {
    if(theme === 'dark'){
      btn.innerHTML='<i class="bi bi-sun-fill"></i><span> 浅色模式</span>';
    } else {
      btn.innerHTML='<i class="bi bi-moon-stars"></i><span> 暗黑模式</span>';
    }
  });
}

function loadTheme(){
  const savedTheme = localStorage.getItem('theme') || 'light';
  updateThemeUI(savedTheme);
}

loadTheme();

// 监听storage事件
window.addEventListener('storage', (e) => {
  if (e.key === 'theme') {
    updateThemeUI(e.newValue || 'light');
  }
});

// 修改主题切换按钮
document.querySelectorAll('.toggle').forEach(btn => {
  btn.addEventListener('click', () => {
    const current = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    updateThemeUI(current);
    localStorage.setItem('theme', current);
  });
});   

// ====== 工具函数 ======
function highlightKeyword(text,keyword){
  if(!keyword) return text;
  const regex=new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');
  return text.replace(regex,'<mark>$1</mark>');
}

// 改进的摘要提取函数 - 彻底移除所有媒体内容
function extractSummary(text){
  // 创建临时元素用于解析HTML
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = text;
  
  // 移除所有媒体元素
  tempDiv.querySelectorAll('img, video, audio, iframe, picture, source, track').forEach(el => el.remove());
  
  // 获取纯文本内容
  let cleanText = tempDiv.textContent || tempDiv.innerText || '';
  
  // 额外处理Markdown图片语法
  cleanText = cleanText.replace(/!\[.*?\]\(.*?\)/g, '');
  
  // 移除多余空格和换行
  cleanText = cleanText.replace(/\s+/g, ' ').trim();
  
  return cleanText.slice(0, 140);
}


function showSkeleton(count=3){
  for(let i=0;i<count;i++){
    const sk=document.createElement('div');
    sk.className='post visible';
    sk.innerHTML=`
      <div class="skeleton" style="height:20px;width:60%;margin-bottom:8px;"></div>
      <div class="skeleton" style="height:14px;width:30%;margin-bottom:12px;"></div>
      <div class="skeleton" style="height:16px;width:100%;margin-bottom:6px;"></div>
      <div class="skeleton" style="height:16px;width:90%;margin-bottom:6px;"></div>
      <div class="skeleton" style="height:16px;width:80%;margin-bottom:6px;"></div>
    `;
    postsContainer.appendChild(sk);
  }
}

// ====== 加载文章 ======
async function loadPosts(keyword='') {
  // 恢复对isLoading的检查
  if (!hasMore || isLoading) return;
  
  // 设置加载锁为true
  isLoading = true;
  
  showSkeleton();
  loadingDiv.style.display='block';
  endOfContentDiv.style.display='none';
  
  try {
    // 构建URL - 只有在有keyword时才添加keyword参数
    let url = `https://api.tang.cafe/api/v1?pagenum=${currentPage}&pageSize=${pageSize}`;
    if (keyword) {
      url += `&keyword=${encodeURIComponent(keyword)}`;
    }
    
    const res = await fetch(url);
    const data = await res.json();
    loadingDiv.style.display='none';
    document.querySelectorAll('.skeleton').forEach(s=>s.parentNode.remove());

    if (data.success && data.data && data.data.length>0) {
      data.data.forEach((post,index)=>{
        const div=document.createElement('div');
        div.className='post';
        div.style.transitionDelay=`${index*100}ms`;
        
        // 构建文章链接 - 只有在有keyword时才添加keyword参数
        let postUrl = `post.html?id=${post.填写ID}`;
        if (keyword) {
          postUrl += `&keyword=${encodeURIComponent(keyword)}`;
        }
        
        div.innerHTML=`
          <div class="post-title" onclick="window.location.href='${postUrl}'">
            <i class="bi bi-file-earmark-text"></i> ${highlightKeyword(post.标题,keyword)}
          </div>
          <div class="post-date"><i class="bi bi-clock"></i> ${new Date(post.日期).toLocaleDateString()}</div>
          <div class="post-summary">${highlightKeyword(extractSummary(post.文章内容),keyword)}...</div>
        `;
        postsContainer.appendChild(div);
        setTimeout(()=>div.classList.add('visible'),50);
      });
      
      // 检查是否还有更多数据
      if (data.data.length < pageSize) {
        hasMore = false;
        endOfContentDiv.style.display = 'block';
      }
      
      currentPage++;
    } else if (currentPage===1) {
      postsContainer.innerHTML='<p>未找到相关文章</p>';
      hasMore = false;
    } else {
      hasMore = false;
      endOfContentDiv.style.display = 'block';
    }
  } catch(e){
    loadingDiv.style.display='none';
    alert('加载失败，请稍后重试');
  } finally {
    // 确保无论成功还是失败，isLoading都会被重置为false
    isLoading = false;
  }
}

// ====== 搜索 ======
function doSearch(){
  postsContainer.innerHTML='';
  currentPage=1;
  hasMore = true;
  currentKeyword=document.getElementById('searchInput').value.trim();
  endOfContentDiv.style.display = 'none';
  updateClearButtonVisibility(); // 更新清除按钮状态
  loadPosts(currentKeyword);
}
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter') doSearch();});
// 添加搜索按钮点击事件监听器
document.getElementById('searchBtn').addEventListener('click', doSearch);

// ====== 滚动事件处理 ======
window.addEventListener('scroll',()=>{
  // 无限滚动
  if(hasMore && !isLoading && window.innerHeight + window.scrollY >= document.body.offsetHeight - 50){
    loadPosts(currentKeyword);
  }

  // 头部滚动效果
  const header = document.querySelector('header');
  if (window.scrollY > 50) {
      header.classList.add('scrolled');
  } else {
      header.classList.remove('scrolled');
  }
});

// 初始化回到顶部按钮
function initBackToTopButton() {
    // 创建按钮元素（如果不存在）
    let backToTopBtn = document.getElementById('backToTop');
    if (!backToTopBtn) {
        backToTopBtn = document.createElement('button');
        backToTopBtn.id = 'backToTop';
        document.body.appendChild(backToTopBtn);
    }

    // 设置按钮内容
    backToTopBtn.innerHTML = `
        <svg viewBox="0 0 1024 1024" width="24" height="24">
            <path d="M351.957333 1015.893333a31.914667 31.914667 0 0 1-31.573333-26.709333L228.864 439.893333H159.957333a32 32 0 0 1 0-64h65.834667a288.213333 288.213333 0 0 1 328.277333-252.928l7.594667-38.869333A95.829333 95.829333 0 0 1 682.154667 11.904l158.677333 45.226667c8.234667 2.346667 15.061333 7.765333 19.2 15.232s5.162667 16.128 2.816 24.32a32.128 32.128 0 0 1-39.594667 22.016l-158.677333-45.226667a32.256 32.256 0 0 0-9.045333-1.28 32.170667 32.170667 0 0 0-31.146667 25.045333l-8.234667 42.24a290.816 290.816 0 0 1 182.144 236.458667h65.792a32 32 0 0 1 0 64H796.586667l-60.842667 547.541333a32 32 0 0 1-31.829333 28.458667H351.957333z m323.370667-64l28.458667-256h-367.36l42.666666 256h296.234667z m35.541333-320l21.333334-192h-174.805334l-37.461333 192h190.933333z m-256.128 0l37.461334-192H293.717333l32 192h129.024z m278.912-256a223.658667 223.658667 0 0 0-130.090666-172.373333l-33.621334 172.373333h163.712z m-228.949333 0l37.077333-190.037333A224.512 224.512 0 0 0 290.346667 375.893333h214.357333z"/>
        </svg>
    `;

    // 滚动事件监听
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.add('visible');
        } else {
            backToTopBtn.classList.remove('visible');
        }
    });

    // 点击事件监听
    backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
}

// 页面加载完成后初始化
window.addEventListener('load', initBackToTopButton);

loadPosts();
</script>
</body>
</html>

