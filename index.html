<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tang.café</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<style>  
/* 原有全局样式保持不变 */
:root {
  --bg: linear-gradient(135deg,#f5f7fa,#c3cfe2);
  --text: #111;
  --card-bg: rgba(255,255,255,0.9);
  --card-shadow: rgba(0,0,0,0.1);
  --accent: #485664;
  --highlight: #ffd54f;
  --skeleton-bg: #ddd;
  --hover-shadow: rgba(0,0,0,0.15);
}
[data-theme="dark"] {
  --bg: linear-gradient(135deg,#1e1e1e,#2c2c2c);
  --text: #eee;
  --card-bg: rgba(30,30,30,0.85);
  --card-shadow: rgba(0,0,0,0.6);
  --accent: #4da6ff;
  --highlight: #ff4040;
  --skeleton-bg: #333;
  --hover-shadow: rgba(0,0,0,0.8);
}
body {
  margin:0; 
  padding:0; /* 修改：移除顶部padding，由header提供 */
  font-family:'Segoe UI',Arial,sans-serif; 
  background:var(--bg); 
  color:var(--text); 
  transition: background 0.3s,color 0.3s;
}

/* ====== 头部优化 ====== */
header {
  display:flex;
  flex-wrap:nowrap; /* 禁止换行 */
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
  padding: 15px 20px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: var(--card-bg);
  box-shadow: 0 4px 12px var(--card-shadow);
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

/* 标题样式 */
header h1 {
  margin:0;
  font-size:28px;
  display:flex;
  align-items:center;
  gap:10px;
  flex-shrink: 0;
  transition: font-size 0.3s ease; /* 只针对字体大小添加过渡 */
}

/* 滚动时头部样式优化 */
header.scrolled {
  padding: 10px 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

header.scrolled h1 {
  font-size: 22px !important; /* 确保滚动时标题不会放大 */
}

/* 响应式优化 */
@media (max-width: 768px) {
  header {
    padding: 10px 15px;
    margin-bottom: 10px;
    flex-direction: row;
    align-items: center;
  }

  header h1 {
    font-size: 20px !important; /* 强制保持该大小 */
    gap: 6px;
    flex-shrink: 0;
  }

  /* 取消移动端的滚动样式变化 */
  header.scrolled h1 {
    font-size: 20px !important;
  }
}

@media (max-width: 480px) {
  header h1 {
    font-size: 18px !important; /* 强制保持该大小 */
  }

  /* 取消移动端的滚动样式变化 */
  header.scrolled h1 {
    font-size: 18px !important;
  }
}

/* 头部控制区 */
.header-controls {
  display:flex; 
  align-items:center; 
  gap:10px; 
  transition: all 0.3s ease;
  position: relative;
}

/* 输入框样式 - 修改为默认显示短搜索框 */
input#searchInput {
  padding:6px 12px; 
  border-radius:5px; 
  border:1px solid transparent; 
  outline:none; 
  width: 100px; /* 短搜索框初始宽度 */
  background:var(--card-bg); 
  color:var(--text); 
  transition: all 0.3s ease; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  display: block; /* 默认显示 */
  z-index: 1001; 
}

/* 搜索框聚焦时变长 */
input#searchInput:focus {
  width: 200px; /* 长搜索框宽度 */
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(72, 86, 100, 0.2);
}

/* 按钮样式 */
button {
  cursor:pointer; 
  padding:6px 12px; 
  border-radius:6px; 
  border:1px solid transparent; 
  background:var(--card-bg); 
  backdrop-filter:blur(5px); 
  display:flex; 
  align-items:center; 
  gap:5px; 
  color:var(--text); 
  transition: all 0.3s ease; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* 搜索按钮禁用状态 */
button#searchBtn:disabled {
  opacity: 0.5; 
  cursor: not-allowed; 
  transform: none; 
  box-shadow: none; 
  border-color: transparent;
}

@keyframes fadeIn {
  from { opacity: 0; width: 0; } 
  to { opacity: 1; width: 200px; }
}

/* 按钮样式 */
button {
  cursor:pointer; 
  padding:6px 12px; 
  border-radius:6px; 
  border:1px solid transparent; 
  background:var(--card-bg); 
  backdrop-filter:blur(5px); 
  display:flex; 
  align-items:center; 
  gap:5px; 
  color:var(--text); 
  transition: all 0.3s ease; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

button:hover {
  transform: translateY(-2px); 
  box-shadow: 0 3px 8px var(--hover-shadow); 
  border-color: var(--accent);
}

/* 主题切换按钮样式 */
#themeToggle {
  padding:6px; 
  min-width: 40px; 
  justify-content: center;
}

/* 搜索按钮样式 */
#searchBtn {
  padding:6px; 
  min-width: 40px; 
  justify-content: center;
  position: relative;
  z-index: 1002; /* 确保在搜索框上方 */
}

/* 主要内容区调整 */
#posts-container {
  margin-top: 100px; /* 确保内容不被固定头部遮挡 */
  padding: 20px;
}

/* 响应式优化 */
@media (max-width: 768px) {
  body {
    padding:0;
  }
  
  header {
    padding: 10px 15px; /* 缩小内边距 */
    margin-bottom: 10px; /* 减小间距 */
    flex-direction: row; /* 修改：恢复水平排列 */
    align-items: center; /* 修改：居中对齐 */
    /* 移除gap属性 */
  }
  
  header h1 {
    font-size: 20px; /* 修改：保持较小字体 */
    gap: 6px;
    flex-shrink: 0; /* 确保标题不被压缩 */
  }
  
  .header-controls {
    gap: 6px; /* 减小间隙 */
    width: auto; /* 修改：适应内容宽度 */
    flex-grow: 1; /* 修改：允许增长 */
    justify-content: flex-end; /* 修改：右对齐 */
    margin-left: 10px; /* 添加左边距 */
  }
  
  input#searchInput {
    right: auto; /* 修改：移除定位 */
    width: 100px; /* 修改：更小宽度 */
    flex-grow: 1; /* 修改：允许增长 */
    min-width: 0; /* 允许缩小到内容宽度 */
  }
  
  /* 修改：移动端隐藏暗黑模式文字 */
  .toggle span {
    display: none;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; width: 0; }
    to { opacity: 1; width: 100px; }
  }
  
  /* 调整内容区间距 */
  #posts-container {
    margin-top: 80px; /* 恢复原来的间距 */
    padding: 15px;
  }
}

@media (max-width: 480px) {
  header h1 {
    font-size: 18px; /* 进一步缩小字体 */
  }
  
  button {
    padding: 6px; /* 调整触摸区域 */
  }
  
  input#searchInput {
    right: auto; /* 修改：移除定位 */
    width: 80px; /* 进一步缩小宽度 */
  }
  
  /* 修改：确保暗黑模式文字在小屏幕也隐藏 */
  .toggle span {
    display: none;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; width: 0; }
    to { opacity: 1; width: 80px; }
  }
  
  /* 更小的内容区间距 */
  #posts-container {
    margin-top: 70px;
    padding: 10px;
  }
}

/* 滚动时头部样式优化 */
header.scrolled {
  padding: 10px 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

header.scrolled h1 {
  font-size: 22px; /* 修改：确保滚动时标题也不放大 */
}

/* 原有内容样式保持不变 */
.post {
  background:var(--card-bg);
  padding:20px;
  border-radius:16px;
  box-shadow:0 6px 16px var(--card-shadow);
  margin-bottom:25px;
  opacity:0;
  transform:translateY(20px);
  transition:all 0.5s ease;
  color:var(--text);
  position: relative;
  overflow: hidden;
  will-change: transform, box-shadow;
}
.post.visible {
  opacity:1; 
  transform:translateY(0);
}
.post:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 24px var(--hover-shadow);
}
.post::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--accent);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 0.4s ease;
}
.post:hover::before {
  transform: scaleX(1);
}
.post-title {
  font-weight:bold;
  cursor:pointer;
  font-size:20px;
  margin-bottom:8px;
  color:var(--accent);
  display:flex;
  align-items:center;
  gap:6px;
  transition: all 0.3s ease;
}
.post-title:hover {
  color: var(--highlight);
}
.post-date {
  font-size:13px;
  color:#888;
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:6px;
}
.post-summary {
  font-size:15px;
  line-height:1.6;
  color:var(--text);
}
mark {
  background-color:var(--highlight);
  color:inherit;
  padding:0 2px;
  border-radius:2px;
}
.skeleton {
  background: var(--skeleton-bg); 
  border-radius: 12px; 
  margin-bottom:12px; 
  position: relative; 
  overflow: hidden;
}
.skeleton::before {
  content:""; 
  display:block; 
  position:absolute; 
  top:0; 
  left:-150px; 
  height:100%; 
  width:150px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation:skeleton-loading 1.2s infinite;
}
@keyframes skeleton-loading {
  0%{left:-150px;}
  100%{left:100%;}
}
#loading {
  text-align:center;
  margin-top:15px;
  font-size:14px;
  color:var(--accent);
}
.end-of-content {
  text-align:center;
  padding:20px;
  color:var(--text);
  font-style: italic;
}

/* ===== 回到顶部按钮 ===== */
#backToTop {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    z-index: 1000;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s, transform 0.3s, background 0.3s;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

#backToTop.visible {
    opacity: 1;
    transform: translateY(0);
}

#backToTop:hover {
    background: var(--highlight);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* 暗黑模式适配 */
[data-theme="dark"] #backToTop {
    box-shadow: 0 3px 10px rgba(0,0,0,0.5);
}

/* 原有媒体查询保持不变 */
</style>
</head>
<body data-theme="light">
<header>
  <h1 id="siteTitle" style="cursor: pointer; transition: transform 0.2s ease;"><i class="bi bi-cup-hot"></i>Tang.café</h1>
  <div class="header-controls">
    <input id="searchInput" type="text" placeholder="搜索文章..." />
    <button id="searchBtn"><i class="bi bi-search"></i></button>
    <button class="toggle"><i class="bi bi-moon-stars"></i> 暗黑模式</button>
  </div>
</header>

<!-- 添加容器包裹内容区域 -->
<div id="posts-container">
  <div id="posts"></div>
  <div id="loading">加载中...</div>
  <div id="endOfContent" class="end-of-content" style="display:none;">木有内容了</div>
</div>

<button id="backToTop" title="回到顶部">
    <i class="bi bi-arrow-up-circle-fill"></i>
</button>

<script>
// 原有JavaScript保持不变
// 恢复isLoading标志
let currentPage=1, pageSize=10, currentKeyword='', hasMore=true, isLoading=false;
const postsContainer=document.getElementById('posts');
const loadingDiv=document.getElementById('loading');
const endOfContentDiv=document.getElementById('endOfContent');

// ====== 搜索框功能 ======
const searchBtn = document.getElementById('searchBtn');
const searchInput = document.getElementById('searchInput');

// 初始化搜索按钮状态
function updateSearchButtonState() {
  const value = searchInput.value.trim();
  searchBtn.disabled = false; // 修改：始终启用搜索按钮
}

// 初始检查
updateSearchButtonState();

// 监听搜索框输入变化
searchInput.addEventListener('input', updateSearchButtonState);

// 移除重复的事件监听器
// 搜索按钮点击事件
searchBtn.addEventListener('click', () => {
  doSearch(); // 修改：移除禁用检查，直接执行搜索
});

// 搜索框失去焦点且无内容时，恢复为短搜索框
searchInput.addEventListener('blur', () => {
  if (searchInput.value.trim().length === 0) {
    // 移除焦点样式，但保持显示
    searchInput.blur();
  }
});

// ====== 标题点击刷新功能 ======
const siteTitle = document.getElementById('siteTitle');

siteTitle.addEventListener('click', () => {
  // 清除搜索框内容
  searchInput.value = '';
  // 刷新内容
  doSearch();
  // 添加点击动画效果
  siteTitle.style.transform = 'scale(0.95)';
  setTimeout(() => {
    siteTitle.style.transform = 'scale(1)';
  }, 200);
});

// 添加悬停效果增强
siteTitle.addEventListener('mouseover', () => {
  siteTitle.style.transform = 'scale(1.03)';
});

siteTitle.addEventListener('mouseout', () => {
  siteTitle.style.transform = 'scale(1)';
});

// 监听搜索框输入变化
searchInput.addEventListener('input', updateSearchButtonState);

// 移除重复的事件监听器
// 搜索按钮点击事件
searchBtn.addEventListener('click', () => {
  doSearch(); // 修改：移除禁用检查，直接执行搜索
});

// 搜索框失去焦点且无内容时，恢复为短搜索框
searchInput.addEventListener('blur', () => {
  if (searchInput.value.trim().length === 0) {
    // 移除焦点样式，但保持显示
    searchInput.blur();
  }
});

// ====== 主题持久化 & 图标文字同步 ======
function updateThemeUI(theme){
  document.body.setAttribute('data-theme',theme);
  document.querySelectorAll('.toggle').forEach(btn=>{
    if(theme==='dark'){
      btn.innerHTML='<i class="bi bi-sun-fill"></i><span> 浅色模式</span>'; // 修改：添加span标签包裹文字
    }else{
      btn.innerHTML='<i class="bi bi-moon-stars"></i><span> 暗黑模式</span>'; // 修改：添加span标签包裹文字
    }
  });
  
  // 广播主题变化给其他页面
  if (window.themeChannel) {
    window.themeChannel.postMessage({ type: 'THEME_CHANGE', theme: theme });
  }
}
function loadTheme(){
  const savedTheme=localStorage.getItem('theme') || 'light';
  updateThemeUI(savedTheme);
}
loadTheme();

// ====== 新增：跨页面主题同步 ======
// 创建广播通道
window.themeChannel = new BroadcastChannel('theme_channel');

// 监听其他页面的主题变化
window.themeChannel.onmessage = (e) => {
  if (e.data.type === 'THEME_CHANGE') {
    updateThemeUI(e.data.theme);
    localStorage.setItem('theme', e.data.theme);
  }
};

// 监听storage事件
window.addEventListener('storage', (e) => {
  if (e.key === 'theme') {
    updateThemeUI(e.newValue || 'light');
  }
});

// 修改主题切换按钮
document.querySelectorAll('.toggle').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const current=document.body.getAttribute('data-theme')==='dark'?'light':'dark';
    updateThemeUI(current);
    localStorage.setItem('theme',current);
    
    // 强制触发storage事件（兼容方案）
    const event = new StorageEvent('storage', {
      key: 'theme',
      newValue: current
    });
    window.dispatchEvent(event);
  });
});   

// ====== 工具函数 ======
function highlightKeyword(text,keyword){
  if(!keyword) return text;
  const regex=new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');
  return text.replace(regex,'<mark>$1</mark>');
}

// 改进的摘要提取函数 - 彻底移除所有媒体内容
function extractSummary(text){
  // 创建临时元素用于解析HTML
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = text;
  
  // 移除所有媒体元素
  tempDiv.querySelectorAll('img, video, audio, iframe, picture, source, track').forEach(el => el.remove());
  
  // 获取纯文本内容
  let cleanText = tempDiv.textContent || tempDiv.innerText || '';
  
  // 额外处理Markdown图片语法
  cleanText = cleanText.replace(/!\[.*?\]\(.*?\)/g, '');
  
  // 移除多余空格和换行
  cleanText = cleanText.replace(/\s+/g, ' ').trim();
  
  return cleanText.slice(0, 140);
}


function showSkeleton(count=3){
  for(let i=0;i<count;i++){
    const sk=document.createElement('div');
    sk.className='post visible';
    sk.innerHTML=`
      <div class="skeleton" style="height:20px;width:60%;margin-bottom:8px;"></div>
      <div class="skeleton" style="height:14px;width:30%;margin-bottom:12px;"></div>
      <div class="skeleton" style="height:16px;width:100%;margin-bottom:6px;"></div>
      <div class="skeleton" style="height:16px;width:90%;margin-bottom:6px;"></div>
      <div class="skeleton" style="height:16px;width:80%;margin-bottom:6px;"></div>
    `;
    postsContainer.appendChild(sk);
  }
}

// ====== 加载文章 ======
async function loadPosts(keyword='') {
  // 恢复对isLoading的检查
  if (!hasMore || isLoading) return;
  
  // 设置加载锁为true
  isLoading = true;
  
  showSkeleton();
  loadingDiv.style.display='block';
  endOfContentDiv.style.display='none';
  
  try {
    const res = await fetch(`https://api.tang.cafe/api/v1?pagenum=${currentPage}&pageSize=${pageSize}&keyword=${encodeURIComponent(keyword)}`);
    const data = await res.json();
    loadingDiv.style.display='none';
    document.querySelectorAll('.skeleton').forEach(s=>s.parentNode.remove());

    if (data.success && data.data && data.data.length>0) {
      data.data.forEach((post,index)=>{
        const div=document.createElement('div');
        div.className='post';
        div.style.transitionDelay=`${index*100}ms`;
        div.innerHTML=`
          <div class="post-title" onclick="window.location.href='post.html?id=${post.填写ID}&keyword=${encodeURIComponent(keyword)}'">
            <i class="bi bi-file-earmark-text"></i> ${highlightKeyword(post.标题,keyword)}
          </div>
          <div class="post-date"><i class="bi bi-clock"></i> ${new Date(post.日期).toLocaleDateString()}</div>
          <div class="post-summary">${highlightKeyword(extractSummary(post.文章内容),keyword)}...</div>
        `;
        postsContainer.appendChild(div);
        setTimeout(()=>div.classList.add('visible'),50);
      });
      
      // 检查是否还有更多数据
      if (data.data.length < pageSize) {
        hasMore = false;
        endOfContentDiv.style.display = 'block';
      }
      
      currentPage++;
    } else if (currentPage===1) {
      postsContainer.innerHTML='<p>未找到相关文章</p>';
      hasMore = false;
    } else {
      hasMore = false;
      endOfContentDiv.style.display = 'block';
    }
  } catch(e){
    loadingDiv.style.display='none';
    alert('加载失败，请稍后重试');
  } finally {
    // 确保无论成功还是失败，isLoading都会被重置为false
    isLoading = false;
  }
}

// ====== 搜索 ======
function doSearch(){
  postsContainer.innerHTML='';
  currentPage=1;
  hasMore = true;
  currentKeyword=document.getElementById('searchInput').value.trim();
  endOfContentDiv.style.display = 'none';
  loadPosts(currentKeyword);
}
// 删除这行重复的事件绑定
// document.getElementById('searchBtn').addEventListener('click',doSearch);
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter') doSearch();});

// ====== 无限滚动 ======
window.addEventListener('scroll',()=>{
  if(hasMore && !isLoading && window.innerHeight + window.scrollY >= document.body.offsetHeight - 50){
    loadPosts(currentKeyword);
  }
});

// 获取返回顶部按钮
const backToTopBtn = document.getElementById('backToTop');

// 监听滚动事件 - 添加头部滚动效果
window.addEventListener('scroll', () => {
    // 回到顶部按钮
    if (window.scrollY > 300) {
        backToTopBtn.classList.add('visible');
    } else {
        backToTopBtn.classList.remove('visible');
    }
    
    // 头部滚动效果
    const header = document.querySelector('header');
    if (window.scrollY > 50) {
        header.classList.add('scrolled');
    } else {
        header.classList.remove('scrolled');
    }
});

// 点击按钮返回顶部
backToTopBtn.addEventListener('click', () => {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
});

loadPosts();
</script>

</body>
</html>