<!DOCTYPE html>
<html lang="zh">
<head>
<link rel="icon" href="./favicon.svg" type="image/svg+xml">
<link rel="icon" href="./favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tang.cafÃ©</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">

<style>  
/* æ–°å¢æ¸…é™¤æŒ‰é’®æ ·å¼ */
.clear-btn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #999;
  cursor: pointer;
  padding: 0;
  font-size: 14px;
  z-index: 1003;
  display: none;
}
.clear-btn:hover {
  color: #666;
}
.search-wrapper {
  position: relative;
  display: inline-block;
}
/* ä¸ºæœç´¢æ¡†å¢åŠ å³ä¾§å†…è¾¹è· */
input#searchInput {
  padding-right: 30px !important;
}
/* æš—é»‘æ¨¡å¼é€‚é… */
[data-theme="dark"] .clear-btn {
  color: #aaa;
}
[data-theme="dark"] .clear-btn:hover {
  color: #ccc;
}

/* åŸæœ‰å…¨å±€æ ·å¼ä¿æŒä¸å˜ */
:root {
  --bg: linear-gradient(135deg,#f5f7fa,#c3cfe2);
  --text: #111;
  --card-bg: rgba(255,255,255,0.9);
  --card-shadow: rgba(0,0,0,0.1);
  --accent: #485664;
  --highlight: #34dbcb;
  --skeleton-bg: #ddd;
  --hover-shadow: rgba(0,0,0,0.15);
}
[data-theme="dark"] {
  --bg: linear-gradient(135deg,#1e1e1e,#2c2c2c);
  --text: #eee;
  --card-bg: rgba(30,30,30,0.85);
  --card-shadow: rgba(0,0,0,0.6);
  --accent: #34dbcb;
  --highlight: #ffffff;
  --skeleton-bg: #333;
  --hover-shadow: rgba(0,0,0,0.8);
}
body {
  margin:0; 
  padding:0; /* ä¿®æ”¹ï¼šç§»é™¤é¡¶éƒ¨paddingï¼Œç”±headeræä¾› */
  font-family:'Segoe UI',Arial,sans-serif; 
  background:var(--bg); 
  color:var(--text); 
  transition: background 0.3s,color 0.3s;
  font-family: 'Noto Serif SC', serif;
}

/* ====== å¤´éƒ¨ä¼˜åŒ– ====== */
header {
  display:flex;
  flex-wrap:nowrap; /* ç¦æ­¢æ¢è¡Œ */
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
  padding: 15px 20px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: var(--card-bg);
  box-shadow: 0 4px 12px var(--card-shadow);
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

/* æ ‡é¢˜æ ·å¼ */
header h1 {
  margin:0;
  font-size:28px;
  display:flex;
  align-items:center;
  gap:10px;
  flex-shrink: 0;
  transition: font-size 0.3s ease, opacity 0.3s ease, transform 0.3s ease; /* æ·»åŠ opacityå’Œtransformè¿‡æ¸¡ */
}

/* ç§»åŠ¨ç«¯æ ‡é¢˜éšè—ç±» */
@media (max-width: 768px) {
  header h1.hidden {
    opacity: 0;
    transform: scale(0.8);
    width: 0;
    overflow: hidden;
    margin-right: -10px; /* è¡¥å¿é—´è· */
  }
}

/* æ»šåŠ¨æ—¶å¤´éƒ¨æ ·å¼ä¼˜åŒ– */
header.scrolled {
  padding: 10px 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

header.scrolled h1 {
  font-size: 22px; /* ä¿®æ”¹ï¼šç¡®ä¿æ»šåŠ¨æ—¶æ ‡é¢˜ä¹Ÿä¸æ”¾å¤§ */
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  header {
    padding: 10px 15px;
    margin-bottom: 10px;
    flex-direction: row;
    align-items: center;
  }

  header h1 {
    font-size: 20px !important; /* å¼ºåˆ¶ä¿æŒè¯¥å¤§å° */
    gap: 6px;
    flex-shrink: 0;
  }

  /* å–æ¶ˆç§»åŠ¨ç«¯çš„æ»šåŠ¨æ ·å¼å˜åŒ– */
  header.scrolled h1 {
    font-size: 20px !important;
  }
  
  /* ç§»åŠ¨ç«¯æ¸…é™¤æŒ‰é’®ä½ç½®è°ƒæ•´ */
  .clear-btn {
    right: 5px;
    font-size: 12px;
  }
}

@media (max-width: 480px) {
  header h1 {
    font-size: 18px !important; /* å¼ºåˆ¶ä¿æŒè¯¥å¤§å° */
  }

  /* å–æ¶ˆç§»åŠ¨ç«¯çš„æ»šåŠ¨æ ·å¼å˜åŒ– */
  header.scrolled h1 {
    font-size: 18px !important;
  }
  
  /* ç§»åŠ¨ç«¯æ¸…é™¤æŒ‰é’®ä½ç½®è°ƒæ•´ */
  .clear-btn {
    right: 4px;
    font-size: 11px;
  }
}

/* å¤´éƒ¨æ§åˆ¶åŒº */
.header-controls {
  display:flex; 
  align-items:center; 
  gap:10px; 
  transition: all 0.3s ease;
  position: relative;
}

/* è¾“å…¥æ¡†æ ·å¼ - ä¿®æ”¹ä¸ºé»˜è®¤æ˜¾ç¤ºçŸ­æœç´¢æ¡† */
input#searchInput {
  padding:6px 12px; 
  border-radius:5px; 
  border:1px solid transparent; 
  outline:none; 
  width: 100px; /* çŸ­æœç´¢æ¡†åˆå§‹å®½åº¦ */
  background:var(--card-bg); 
  color:var(--text); 
  transition: all 0.3s ease; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  display: block; /* é»˜è®¤æ˜¾ç¤º */
  z-index: 1001; 
}

/* æœç´¢æ¡†èšç„¦æ—¶å˜é•¿ */
input#searchInput:focus {
  width: 200px; /* é•¿æœç´¢æ¡†å®½åº¦ */
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(72, 86, 100, 0.2);
}

/* æŒ‰é’®æ ·å¼ */
button {
  cursor:pointer; 
  padding:6px 12px; 
  border-radius:6px; 
  border:1px solid transparent; 
  background:var(--card-bg); 
  backdrop-filter:blur(5px); 
  display:flex; 
  align-items:center; 
  gap:5px; 
  color:var(--text); 
  transition: all 0.3s ease; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}



@keyframes fadeIn {
  from { opacity: 0; width: 0; } 
  to { opacity: 1; width: 200px; }
}

button:hover {
  transform: translateY(-2px); 
  box-shadow: 0 3px 8px var(--hover-shadow); 
  border-color: var(--accent);
}


/* æœç´¢æŒ‰é’®æ ·å¼ */
#searchBtn {
  padding:6px; 
  min-width: 40px; 
  justify-content: center;
  position: relative;
  z-index: 1002; /* ç¡®ä¿åœ¨æœç´¢æ¡†ä¸Šæ–¹ */
}

/* ä¸»è¦å†…å®¹åŒºè°ƒæ•´ */
#posts-container {
  margin-top: 100px; /* ç¡®ä¿å†…å®¹ä¸è¢«å›ºå®šå¤´éƒ¨é®æŒ¡ */
  padding: 20px;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  body {
    padding:0;
  }
  
  header {
    padding: 10px 15px; /* ç¼©å°å†…è¾¹è· */
    margin-bottom: 10px; /* å‡å°é—´è· */
    flex-direction: row; /* ä¿®æ”¹ï¼šæ¢å¤æ°´å¹³æ’åˆ— */
    align-items: center; /* ä¿®æ”¹ï¼šå±…ä¸­å¯¹é½ */
    /* ç§»é™¤gapå±æ€§ */
  }
  
  header h1 {
    font-size: 20px; /* ä¿®æ”¹ï¼šä¿æŒè¾ƒå°å­—ä½“ */
    gap: 6px;
    flex-shrink: 0; /* ç¡®ä¿æ ‡é¢˜ä¸è¢«å‹ç¼© */
  }
  
  .header-controls {
    gap: 6px; /* å‡å°é—´éš™ */
    width: auto; /* ä¿®æ”¹ï¼šé€‚åº”å†…å®¹å®½åº¦ */
    flex-grow: 1; /* ä¿®æ”¹ï¼šå…è®¸å¢é•¿ */
    justify-content: flex-end; /* ä¿®æ”¹ï¼šå³å¯¹é½ */
    margin-left: 10px; /* æ·»åŠ å·¦è¾¹è· */
  }
  
  input#searchInput {
    right: auto; /* ä¿®æ”¹ï¼šç§»é™¤å®šä½ */
    width: 100px; /* ä¿®æ”¹ï¼šæ›´å°å®½åº¦ */
    flex-grow: 1; /* ä¿®æ”¹ï¼šå…è®¸å¢é•¿ */
    min-width: 0; /* å…è®¸ç¼©å°åˆ°å†…å®¹å®½åº¦ */
  }
  
  /* ä¿®æ”¹ï¼šç§»åŠ¨ç«¯éšè—æš—é»‘æ¨¡å¼æ–‡å­— */
  .toggle span {
    display: none;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; width: 0; }
    to { opacity: 1; width: 100px; }
  }
  
  /* è°ƒæ•´å†…å®¹åŒºé—´è· */
  #posts-container {
    margin-top: 80px; /* æ¢å¤åŸæ¥çš„é—´è· */
    padding: 15px;
  }
}

@media (max-width: 480px) {
  header h1 {
    font-size: 18px; /* è¿›ä¸€æ­¥ç¼©å°å­—ä½“ */
  }
  
  button {
    padding: 6px; /* è°ƒæ•´è§¦æ‘¸åŒºåŸŸ */
  }
  
  input#searchInput {
    right: auto; /* ä¿®æ”¹ï¼šç§»é™¤å®šä½ */
    width: 80px; /* è¿›ä¸€æ­¥ç¼©å°å®½åº¦ */
  }
  
  /* ä¿®æ”¹ï¼šç¡®ä¿æš—é»‘æ¨¡å¼æ–‡å­—åœ¨å°å±å¹•ä¹Ÿéšè— */
  .toggle span {
    display: none;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; width: 0; }
    to { opacity: 1; width: 80px; }
  }
  
  /* æ›´å°çš„å†…å®¹åŒºé—´è· */
  #posts-container {
    margin-top: 70px;
    padding: 10px;
  }
}

/* åŸæœ‰å†…å®¹æ ·å¼ä¿æŒä¸å˜ */
.post {
  background:var(--card-bg);
  padding:20px;
  border-radius:16px;
  box-shadow:0 6px 16px var(--card-shadow);
  margin-bottom:25px;
  opacity:0;
  transform:translateY(20px);
  transition:all 0.5s ease;
  color:var(--text);
  position: relative;
  overflow: hidden;
  will-change: transform, box-shadow;
}
.post.visible {
  opacity:1; 
  transform:translateY(0);
}
.post:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 24px var(--hover-shadow);
}
.post::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--accent);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 0.4s ease;
}
.post:hover::before {
  transform: scaleX(1);
}
.post-title {
  font-weight:bold;
  cursor:pointer;
  font-size:20px;
  margin-bottom:8px;
  color:var(--accent);
  display:flex;
  align-items:center;
  gap:6px;
  transition: all 0.3s ease;
}
.post-title:hover {
  color: var(--highlight);
}
.post-date {
  font-size:13px;
  color:#888;
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:6px;
}
.post-summary {
  font-size:15px;
  line-height:1.6;
  color:var(--text);
}
mark {
  background-color:var(--highlight);
  color:inherit;
  padding:0 2px;
  border-radius:2px;
}
.skeleton {
  background: var(--skeleton-bg); 
  border-radius: 12px; 
  margin-bottom:12px; 
  position: relative; 
  overflow: hidden;
}
.skeleton::before {
  content:""; 
  display:block; 
  position:absolute; 
  top:0; 
  left:-150px; 
  height:100%; 
  width:150px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation:skeleton-loading 1.2s infinite;
}
@keyframes skeleton-loading {
  0%{left:-150px;}
  100%{left:100%;}
}
#loading {
  text-align:center;
  margin-top:15px;
  font-size:14px;
  color:var(--accent);
}
.end-of-content {
  text-align:center;
  padding:20px;
  color:var(--text);
  font-style: italic;
}

/* ===== å›åˆ°é¡¶éƒ¨æŒ‰é’® ===== */
#backToTop {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s, transform 0.3s, background 0.3s;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

#backToTop.visible {
    opacity: 1;
    transform: translateY(0);
}

#backToTop svg {
    width: 24px;
    height: 24px;
    fill: white;
    transition: fill 0.3s;
}

/* æš—é»‘æ¨¡å¼é€‚é… */
[data-theme="dark"] #backToTop svg {
    fill: white;
}

/* åŠ è½½ä¸­æ—‹è½¬å›¾æ ‡åŠ¨ç”» */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.spinner {
  display: inline-block;
  animation: spin 1s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}
/* æš—é»‘æ¨¡å¼é€‚é… */
[data-theme="dark"] .spinner {
  color: var(--accent);
}

/* åŸæœ‰åª’ä½“æŸ¥è¯¢ä¿æŒä¸å˜ */
</style>
</head>
<body data-theme="light">
<header>
  <h1 id="siteTitle" style="cursor: pointer; transition: transform 0.2s ease;"><i class="bi bi-cup-hot"></i>Tang.cafÃ©</h1>
  <div class="header-controls">
    <div class="search-wrapper">
      <input id="searchInput" type="text" placeholder="æœç´¢æ–‡ç« ..." />
      <button id="clearSearchBtn" class="clear-btn"><i class="bi bi-x-lg"></i></button>
    </div>
    <button id="searchBtn"><i class="bi bi-search"></i></button>
    <button class="toggle"><i class="bi bi-moon-stars"></i> æš—é»‘æ¨¡å¼</button>
  </div>
</header>

<!-- æ·»åŠ å®¹å™¨åŒ…è£¹å†…å®¹åŒºåŸŸ -->
<div id="posts-container">
  <div id="posts"></div>
  <div id="loading"><i class="bi bi-arrow-repeat spinner"></i>ç–¯ç‹‚åŠ è½½ä¸­</div>
  <div id="endOfContent" class="end-of-content" style="display:none;">åˆ°åº•äº†ï¼Œåˆ«æ‹‰äº†ğŸ˜…</div>
</div>



<script>
// æ¢å¤isLoadingæ ‡å¿—
let currentPage=1, pageSize=10, currentKeyword='', hasMore=true, isLoading=false;
const postsContainer=document.getElementById('posts');
const loadingDiv=document.getElementById('loading');
const endOfContentDiv=document.getElementById('endOfContent');
const siteTitle = document.getElementById('siteTitle');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearchBtn = document.getElementById('clearSearchBtn'); // æ–°å¢


// ====== æ¸…é™¤æŒ‰é’®åŠŸèƒ½ ======
function updateClearButtonVisibility() {
  clearSearchBtn.style.display = searchInput.value.trim() ? 'block' : 'none';
}

// æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
clearSearchBtn.addEventListener('click', () => {
  // æ¸…é™¤æœç´¢æ¡†å†…å®¹
  searchInput.value = '';
  updateClearButtonVisibility();
  
  // é€€å‡ºæœç´¢çŠ¶æ€ä½†ä¸æ¸…é™¤ç°æœ‰å†…å®¹
  if (currentKeyword) {
    currentKeyword = '';
    // ç¡®ä¿æ ‡é¢˜åœ¨ç§»åŠ¨ç«¯å¯è§
    if (window.innerWidth <= 768) {
      siteTitle.classList.remove('hidden');
    }
    // ä¿ç•™å½“å‰å†…å®¹ï¼Œåªæ¸…é™¤æœç´¢çŠ¶æ€
    currentPage = 1;
    hasMore = true;
    postsContainer.innerHTML = '';
    endOfContentDiv.style.display = 'none';
    loadPosts('');
  }
});

// ====== æœç´¢æ¡†åŠŸèƒ½ ======

// åˆå§‹åŒ–æœç´¢æŒ‰é’®çŠ¶æ€
function updateSearchButtonState() {
  const value = searchInput.value.trim();
  searchBtn.disabled = false; // ä¿®æ”¹ï¼šå§‹ç»ˆå¯ç”¨æœç´¢æŒ‰é’®
  updateClearButtonVisibility(); // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
}

// åˆå§‹æ£€æŸ¥
updateSearchButtonState();

// ç›‘å¬æœç´¢æ¡†è¾“å…¥å˜åŒ–
searchInput.addEventListener('input', updateSearchButtonState);

// æœç´¢æ¡†å¤±å»ç„¦ç‚¹ä¸”æ— å†…å®¹æ—¶ï¼Œæ¢å¤ä¸ºçŸ­æœç´¢æ¡†
searchInput.addEventListener('blur', () => {
  if (searchInput.value.trim().length === 0) {
    // ç§»é™¤ç„¦ç‚¹æ ·å¼ï¼Œä½†ä¿æŒæ˜¾ç¤º
    searchInput.blur();
    // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œæ˜¾ç¤ºæ ‡é¢˜
    if (window.innerWidth <= 768) {
      siteTitle.classList.remove('hidden');
    }
  }
});

// æ·»åŠ æœç´¢æ¡†èšç„¦äº‹ä»¶ç›‘å¬å™¨ - ç§»åŠ¨ç«¯éšè—æ ‡é¢˜
searchInput.addEventListener('focus', () => {
  // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
  if (window.innerWidth <= 768) {
    siteTitle.classList.add('hidden');
  }
  updateClearButtonVisibility(); // ç¡®ä¿æ¸…é™¤æŒ‰é’®å¯è§æ€§æ­£ç¡®
});

// æ·»åŠ çª—å£å¤§å°å˜åŒ–äº‹ä»¶ç›‘å¬å™¨ - ç¡®ä¿åœ¨çª—å£å¤§å°å˜åŒ–æ—¶æ­£ç¡®æ˜¾ç¤º/éšè—æ ‡é¢˜
window.addEventListener('resize', () => {
  // å¦‚æœä¸æ˜¯ç§»åŠ¨ç«¯ï¼Œç¡®ä¿æ ‡é¢˜å¯è§
  if (window.innerWidth > 768) {
    siteTitle.classList.remove('hidden');
  } else if (searchInput.value.trim().length === 0 && document.activeElement !== searchInput) {
    // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œæœç´¢æ¡†ä¸ºç©ºï¼Œä¸”æœç´¢æ¡†æœªèšç„¦ï¼Œåˆ™æ˜¾ç¤ºæ ‡é¢˜
    siteTitle.classList.remove('hidden');
  }
});

// ====== æ ‡é¢˜ç‚¹å‡»åˆ·æ–°åŠŸèƒ½ ======

siteTitle.addEventListener('click', () => {
  // æ¸…é™¤æœç´¢æ¡†å†…å®¹
  searchInput.value = '';
  updateClearButtonVisibility();
  // åˆ·æ–°å†…å®¹
  doSearch();
  // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
  siteTitle.style.transform = 'scale(0.95)';
  setTimeout(() => {
    siteTitle.style.transform = 'scale(1)';
  }, 200);
  // ç¡®ä¿æ ‡é¢˜å¯è§
  siteTitle.classList.remove('hidden');
});

// æ·»åŠ æ‚¬åœæ•ˆæœå¢å¼º
siteTitle.addEventListener('mouseover', () => {
  siteTitle.style.transform = 'scale(1.03)';
});

siteTitle.addEventListener('mouseout', () => {
  siteTitle.style.transform = 'scale(1)';
});

// ====== ä¸»é¢˜æŒä¹…åŒ– & å›¾æ ‡æ–‡å­—åŒæ­¥ ======
function updateThemeUI(theme){
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('.toggle').forEach(btn => {
    if(theme === 'dark'){
      btn.innerHTML='<i class="bi bi-sun-fill"></i><span> æµ…è‰²æ¨¡å¼</span>';
    } else {
      btn.innerHTML='<i class="bi bi-moon-stars"></i><span> æš—é»‘æ¨¡å¼</span>';
    }
  });
}

function loadTheme(){
  const savedTheme = localStorage.getItem('theme') || 'light';
  updateThemeUI(savedTheme);
}

loadTheme();

// ç›‘å¬storageäº‹ä»¶
window.addEventListener('storage', (e) => {
  if (e.key === 'theme') {
    updateThemeUI(e.newValue || 'light');
  }
});

// ä¿®æ”¹ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
document.querySelectorAll('.toggle').forEach(btn => {
  btn.addEventListener('click', () => {
    const current = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    updateThemeUI(current);
    localStorage.setItem('theme', current);
  });
});   

// ====== å·¥å…·å‡½æ•° ======
function highlightKeyword(text,keyword){
  if(!keyword) return text;
  const regex=new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');
  return text.replace(regex,'<mark>$1</mark>');
}

// æ”¹è¿›çš„æ‘˜è¦æå–å‡½æ•° - å½»åº•ç§»é™¤æ‰€æœ‰åª’ä½“å†…å®¹
function extractSummary(text){
  // åˆ›å»ºä¸´æ—¶å…ƒç´ ç”¨äºè§£æHTML
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = text;
  
  // ç§»é™¤æ‰€æœ‰åª’ä½“å…ƒç´ 
  tempDiv.querySelectorAll('img, video, audio, iframe, picture, source, track').forEach(el => el.remove());
  
  // è·å–çº¯æ–‡æœ¬å†…å®¹
  let cleanText = tempDiv.textContent || tempDiv.innerText || '';
  
  // é¢å¤–å¤„ç†Markdownå›¾ç‰‡è¯­æ³•
  cleanText = cleanText.replace(/!\[.*?\]\(.*?\)/g, '');
  
  // ç§»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
  cleanText = cleanText.replace(/\s+/g, ' ').trim();
  
  return cleanText.slice(0, 140);
}


function showSkeleton(count=3){
  for(let i=0;i<count;i++){
    const sk=document.createElement('div');
    sk.className='post visible';
    sk.innerHTML=`
      <div class="skeleton" style="height:20px;width:60%;margin-bottom:8px;"></div>
      <div class="skeleton" style="height:14px;width:30%;margin-bottom:12px;"></div>
      <div class="skeleton" style="height:16px;width:100%;margin-bottom:6px;"></div>
      <div class="skeleton" style="height:16px;width:90%;margin-bottom:6px;"></div>
      <div class="skeleton" style="height:16px;width:80%;margin-bottom:6px;"></div>
    `;
    postsContainer.appendChild(sk);
  }
}

// ====== åŠ è½½æ–‡ç«  ======
async function loadPosts(keyword='') {
  // æ¢å¤å¯¹isLoadingçš„æ£€æŸ¥
  if (!hasMore || isLoading) return;
  
  // è®¾ç½®åŠ è½½é”ä¸ºtrue
  isLoading = true;
  
  showSkeleton();
  loadingDiv.style.display='block';
  endOfContentDiv.style.display='none';
  
  try {
    const res = await fetch(`https://api.tang.cafe/api/v1?pagenum=${currentPage}&pageSize=${pageSize}&keyword=${encodeURIComponent(keyword)}`);
    const data = await res.json();
    loadingDiv.style.display='none';
    document.querySelectorAll('.skeleton').forEach(s=>s.parentNode.remove());

    if (data.success && data.data && data.data.length>0) {
      data.data.forEach((post,index)=>{
        const div=document.createElement('div');
        div.className='post';
        div.style.transitionDelay=`${index*100}ms`;
        div.innerHTML=`
          <div class="post-title" onclick="window.location.href='post.html?id=${post.å¡«å†™ID}&keyword=${encodeURIComponent(keyword)}'">
            <i class="bi bi-file-earmark-text"></i> ${highlightKeyword(post.æ ‡é¢˜,keyword)}
          </div>
          <div class="post-date"><i class="bi bi-clock"></i> ${new Date(post.æ—¥æœŸ).toLocaleDateString()}</div>
          <div class="post-summary">${highlightKeyword(extractSummary(post.æ–‡ç« å†…å®¹),keyword)}...</div>
        `;
        postsContainer.appendChild(div);
        setTimeout(()=>div.classList.add('visible'),50);
      });
      
      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
      if (data.data.length < pageSize) {
        hasMore = false;
        endOfContentDiv.style.display = 'block';
      }
      
      currentPage++;
    } else if (currentPage===1) {
      postsContainer.innerHTML='<p>æœªæ‰¾åˆ°ç›¸å…³æ–‡ç« </p>';
      hasMore = false;
    } else {
      hasMore = false;
      endOfContentDiv.style.display = 'block';
    }
  } catch(e){
    loadingDiv.style.display='none';
    alert('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  } finally {
    // ç¡®ä¿æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒisLoadingéƒ½ä¼šè¢«é‡ç½®ä¸ºfalse
    isLoading = false;
  }
}

// ====== æœç´¢ ======
function doSearch(){
  postsContainer.innerHTML='';
  currentPage=1;
  hasMore = true;
  currentKeyword=document.getElementById('searchInput').value.trim();
  endOfContentDiv.style.display = 'none';
  updateClearButtonVisibility(); // æ›´æ–°æ¸…é™¤æŒ‰é’®çŠ¶æ€
  loadPosts(currentKeyword);
}
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter') doSearch();});
// æ·»åŠ æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
document.getElementById('searchBtn').addEventListener('click', doSearch);

// ====== æ»šåŠ¨äº‹ä»¶å¤„ç† ======
window.addEventListener('scroll',()=>{
  // æ— é™æ»šåŠ¨
  if(hasMore && !isLoading && window.innerHeight + window.scrollY >= document.body.offsetHeight - 50){
    loadPosts(currentKeyword);
  }

  // å¤´éƒ¨æ»šåŠ¨æ•ˆæœ
  const header = document.querySelector('header');
  if (window.scrollY > 50) {
      header.classList.add('scrolled');
  } else {
      header.classList.remove('scrolled');
  }
});

// åˆå§‹åŒ–å›åˆ°é¡¶éƒ¨æŒ‰é’®
function initBackToTopButton() {
    // åˆ›å»ºæŒ‰é’®å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    let backToTopBtn = document.getElementById('backToTop');
    if (!backToTopBtn) {
        backToTopBtn = document.createElement('button');
        backToTopBtn.id = 'backToTop';
        document.body.appendChild(backToTopBtn);
    }

    // è®¾ç½®æŒ‰é’®å†…å®¹
    backToTopBtn.innerHTML = `
        <svg viewBox="0 0 1024 1024" width="24" height="24">
            <path d="M351.957333 1015.893333a31.914667 31.914667 0 0 1-31.573333-26.709333L228.864 439.893333H159.957333a32 32 0 0 1 0-64h65.834667a288.213333 288.213333 0 0 1 328.277333-252.928l7.594667-38.869333A95.829333 95.829333 0 0 1 682.154667 11.904l158.677333 45.226667c8.234667 2.346667 15.061333 7.765333 19.2 15.232s5.162667 16.128 2.816 24.32a32.128 32.128 0 0 1-39.594667 22.016l-158.677333-45.226667a32.256 32.256 0 0 0-9.045333-1.28 32.170667 32.170667 0 0 0-31.146667 25.045333l-8.234667 42.24a290.816 290.816 0 0 1 182.144 236.458667h65.792a32 32 0 0 1 0 64H796.586667l-60.842667 547.541333a32 32 0 0 1-31.829333 28.458667H351.957333z m323.370667-64l28.458667-256h-367.36l42.666666 256h296.234667z m35.541333-320l21.333334-192h-174.805334l-37.461333 192h190.933333z m-256.128 0l37.461334-192H293.717333l32 192h129.024z m278.912-256a223.658667 223.658667 0 0 0-130.090666-172.373333l-33.621334 172.373333h163.712z m-228.949333 0l37.077333-190.037333A224.512 224.512 0 0 0 290.346667 375.893333h214.357333z"/>
        </svg>
    `;

    // æ»šåŠ¨äº‹ä»¶ç›‘å¬
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.add('visible');
        } else {
            backToTopBtn.classList.remove('visible');
        }
    });

    // ç‚¹å‡»äº‹ä»¶ç›‘å¬
    backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', initBackToTopButton);

loadPosts();
</script>
</body>
</html>

